using RF_SPIDER_VER2.Model;
using System.Collections.Concurrent;
using System.Net;
using System.Net.Sockets;
using System.Text;
using clsRFMeter;
using System.IO;
using DevExpress.Mvvm.Native;
using static RF_SPIDER_VER2.clientmanagerV4;
using RF_SPIDER_VER2.Modem;
using System.Globalization;
using clsRFMeter.Protocol;
using static RF_SPIDER_VER2.clsData;
using DevExpress.XtraEditors.Controls;
using DevExpress.CodeParser;

namespace RF_SPIDER_VER2
{
    public class AsyncServerDCU
    {
        #region VARIABLES
        public int numConnectedSockets;
        private static bool already_Notified = false; //cờ đọc biểu giá billing tại điểm đo fail
        CancellationTokenSource cts;
        TcpListener listener;
        private int maxConnectedClients;
        private ConcurrentDictionary<string, Task> tasks;
        private ConcurrentDictionary<string, TaskCompletionSource<object>> cts_dcu;
        public event Action<UInt32, string> StatusChanged;
        public event EventHandler ReadingCompleted; // Tri PH bổ sung để tạo sự kiện khi DCU hoàn tất đọc
        clientmanagerV4 dcu;
        public static List<DateTime> AutoReadTimestamps = new List<DateTime>();//thống kê thời gian đọc tự động
        public bool isReadingTimeOfBilling { get; set; }
        public bool isBillingInitialized { get; set; }
        public uint SerialID { get; set; }
        public string cloai { get; set; }
        public uint push_time_start { get; set; }
        public uint push_max_time { get; set; }
        public uint push_read_times_day { get; set; }
        public uint push_retry_time_list { get; set; }
        public uint push_retry_time_ddo { get; set; }
        public string MeterType { get; set; }
        public string pathread { get; set; }
        public string loaiBCS;
        public byte cmdType;
        private int amountRead = 0;
        private List<command> commandQueue = new List<command>();
        private System.Threading.Timer autoReadTimer;
        byte[] Data { get; set; }
        public ConcurrentDictionary<string, ModemInfo> clients { get; set; }
        ModemInfo modem = new ModemInfo();
        public string bdpt_metertype { get; set; }
        #endregion

        #region INITIALIZE
        public AsyncServerDCU(int port, int maxConnectedClients)
        {
            cts = new CancellationTokenSource();
            listener = new TcpListener(IPAddress.Any, port);
            this.numConnectedSockets = 0;
            this.maxConnectedClients = maxConnectedClients;
            tasks = new ConcurrentDictionary<string, Task>();
            clsGeneral.clientList = new ConcurrentDictionary<UInt32, clientmanagerV4>();
            cts_dcu = new ConcurrentDictionary<string, TaskCompletionSource<object>>();
        }
        #endregion

        #region KẾT NỐI BAN ĐẦU
        public void RunDCU()
        {
            try
            {
                listener.Start();//bắt đầu lắng nghe
                var task = AcceptClientsAsyncDCU(listener, cts.Token);
                if (task.IsFaulted)
                    task.Wait();
            }
            catch (Exception e)
            {
                throw e;
            }
        }
        private async Task AcceptClientsAsyncDCU(TcpListener listener, CancellationToken token)
        {
            try
            {
                var ip = string.Empty;
                while (!token.IsCancellationRequested)//check liên tục cho đến khi bị huỷ
                {
                    if (numConnectedSockets >= maxConnectedClients)//kiểm tra giới hạn kết nối
                    {
                        listener.Stop();
                        numConnectedSockets = 0;
                        break;
                    }
                    TcpClient client = await listener.AcceptTcpClientAsync().ConfigureAwait(false);//chấp nhận TCP mới

                    client.Client.NoDelay = true;
                    client.Client.SendTimeout = 60000 * 5;
                    client.Client.ReceiveTimeout = 60000 * 5;
                    ip = client.Client.RemoteEndPoint.ToString();
                    Console.WriteLine($"{DateTime.Now.ToString()}\tHello IP : {ip}");
                    var echoasync = EchoAsyncDCU(client, ip, token);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"{DateTime.Now} <== {ex.Message}");
            }
        }
        private async Task EchoAsyncDCU(TcpClient client, string ip, CancellationToken ct)
        {
            try
            {
                using (client)
                {
                    NetworkStream stream = client.GetStream();//tác vụ đọc ghi qua TCP
                    try
                    {
                        await HandleConnection(client, stream, ct);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"{DateTime.Now.ToString()} - Loi xu ly ket noi: {ex.Message}");
                    }
                }
            }
            catch (Exception) { }
        }
        private async Task HandleConnection(TcpClient tcpClient, NetworkStream stream, CancellationToken ct)
        {
            ModemInfo modem = new ModemInfo();
            try
            {
                byte[] buf = new byte[250];
                var timeoutTask = Task.Delay(TimeSpan.FromSeconds(300));//đọc từ stream, timeout 300s
                var amountReadTask = stream.ReadAsync(buf, 0, buf.Length, ct);
                var completedTask = await Task.WhenAny(timeoutTask, amountReadTask).ConfigureAwait(false);
                if (completedTask == timeoutTask) return;
                if (amountReadTask.IsFaulted || amountReadTask.IsCanceled)
                {
                    if (amountReadTask.Exception != null)
                    {
                        var innerEx = amountReadTask.Exception.InnerException;
                        if (innerEx is SocketException || innerEx is IOException)
                        {
                            AppendLog(ref dcu, true, true,
                                $"Mất kết nối TCP: {innerEx.Message}",
                                Color.Red, Color.Red);
                        }
                        else
                        {
                            Console.WriteLine($"{DateTime.Now}\t AmountReadTask fault: {amountReadTask.Exception}");
                        }
                    }

                    // ✅ Đánh dấu DCU offline và cleanup
                    await Update_Status(dcu, STATUS.Offline);
                    if (dcu.mStation != null)
                    {
                        dcu.mStation.COUNTER_DISCONNECTED++;
                        int idx = clsGeneral.stationBindingList.IndexOf(dcu.mStation);
                        if (idx >= 0)
                        {
                            clsGeneral.stationBindingList[idx].COUNTER_DISCONNECTED = dcu.mStation.COUNTER_DISCONNECTED;
                            clsGeneral.stationBindingList.ResetItem(idx);
                        }
                    }
                    throw new IOException("DCU connection lost", amountReadTask.Exception);
                }
                int amountRead = await amountReadTask.ConfigureAwait(false);
                string str = Encoding.GetEncoding("iso-8859-1").GetString(buf, 0, amountRead);
                Console.WriteLine($"{DateTime.Now} \t<=== Auto: {string.Join(" ", str)}");
                STATION sTATION = new STATION();
                if (clsGeneral.check_imei(str, sTATION) != 0) return;
                // Lấy IP từ TcpClient
                IPEndPoint remoteIpEndPoint = tcpClient.Client.RemoteEndPoint as IPEndPoint;
                if (remoteIpEndPoint != null)
                {
                    sTATION.IP_ADDRESS = remoteIpEndPoint.Address.ToString();
                }
                sTATION.PORT = remoteIpEndPoint.Port;
                if (!clsGeneral.clientList.TryGetValue(sTATION.MASTER_ID, out dcu))
                {
                    dcu = new clientmanagerV4();
                    clsGeneral.clientList[sTATION.MASTER_ID] = dcu;
                }
                //dcu.mStation = clsGeneral.stationBindingList.FirstOrDefault(s => s.MASTER_ID == dcu.masterID);
                //int idx = clsGeneral.stationBindingList.IndexOf(dcu.mStation);
                var matchedStation = clsGeneral.stationBindingList.FirstOrDefault(s => s.MASTER_ID == sTATION.MASTER_ID);//Tìm station matching trong stationbidinglist
                if (matchedStation != null)
                {
                    dcu.mStation = matchedStation;
                    int idx = clsGeneral.stationBindingList.IndexOf(dcu.mStation);
                    if (idx >= 0)
                    {
                        clsGeneral.stationBindingList[idx].IMEI = sTATION.IMEI;
                        clsGeneral.stationBindingList[idx].DEVICE_VER = sTATION.DEVICE_VER;
                        clsGeneral.stationBindingList[idx].SIM = sTATION.SIM;
                        clsGeneral.stationBindingList[idx].PORT = sTATION.PORT;
                        LogSIMInfo(idx, sTATION.SIM); //ghi ra file
                        clsGeneral.stationBindingList[idx].IP_ADDRESS = sTATION.IP_ADDRESS;
                        clsGeneral.stationBindingList[idx].RATE_ON = sTATION.RATE_ON;
                        clsGeneral.stationBindingList[idx].RATE_STR = sTATION.RATE_STR;
                        clsGeneral.stationBindingList[idx].CSQ = sTATION.CSQ;
                        dcu.mStation.COUNTER_CONNECTED++;
                        clsGeneral.stationBindingList[idx].COUNTER_CONNECTED = dcu.mStation.COUNTER_CONNECTED;
                        clsGeneral.stationBindingList.ResetItem(idx);
                    }
                }
                else
                {
                    clsGeneral.stationBindingList.Add(sTATION);
                    dcu.mStation = sTATION;
                    int idx = clsGeneral.stationBindingList.IndexOf(dcu.mStation);
                    if (idx >= 0)
                    {
                        clsGeneral.stationBindingList[idx].IMEI = sTATION.IMEI;
                        clsGeneral.stationBindingList[idx].DEVICE_VER = sTATION.DEVICE_VER;
                        clsGeneral.stationBindingList[idx].SIM = sTATION.SIM;
                        clsGeneral.stationBindingList[idx].PORT = sTATION.PORT;
                        LogSIMInfo(idx, sTATION.SIM); //ghi ra file
                        clsGeneral.stationBindingList[idx].IP_ADDRESS = sTATION.IP_ADDRESS;
                        clsGeneral.stationBindingList[idx].RATE_ON = sTATION.RATE_ON;
                        clsGeneral.stationBindingList[idx].RATE_STR = sTATION.RATE_STR;
                        clsGeneral.stationBindingList[idx].CSQ = sTATION.CSQ;
                        dcu.mStation.COUNTER_CONNECTED++;
                        clsGeneral.stationBindingList[idx].COUNTER_CONNECTED = dcu.mStation.COUNTER_CONNECTED;
                        clsGeneral.stationBindingList.ResetItem(idx);
                    }
                }
                await stream.WriteAsync(clsGeneral.CMD_OK, 0, clsGeneral.CMD_OK.Length);
                LogRawBytes(dcu.cmds.serial.ToString(), "SEND", clsGeneral.CMD_OK);
                //dcu.mStation = clsGeneral.stationBindingList.FirstOrDefault(s => s.MASTER_ID == dcu.masterID);
                await Update_Status(dcu, STATUS.Online);
                dcu.tcpClient = tcpClient;
                AppendLog(ref dcu, true, true, "Active DCU thành công", Color.Blue, Color.Blue);
                dcu.init_data();
                //dcu.SetTimer();
                Interlocked.Increment(ref this.numConnectedSockets);
                await ProcessDataLoop(dcu);
            }
            catch (IOException ex)//nguyennvp 24/07/2025
            {
                tcpClient.Close();
                dcu.tcpClient = null;
                await Update_Status(dcu, STATUS.Offline);
                if (dcu.mStation != null)
                {
                    dcu.mStation.COUNTER_DISCONNECTED++;
                    int idx = clsGeneral.stationBindingList.IndexOf(dcu.mStation);
                    if (idx >= 0)
                    {
                        clsGeneral.stationBindingList[idx].COUNTER_DISCONNECTED = dcu.mStation.COUNTER_DISCONNECTED;
                        clsGeneral.stationBindingList.ResetItem(idx);
                    }
                }
                clsGeneral.clientList.TryRemove(dcu.masterID, out _);
                Interlocked.Decrement(ref this.numConnectedSockets);
                Console.WriteLine($"Client disconnected: {ex.Message}");
                if (dcu != null) await Update_Status(dcu, STATUS.Offline);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"{DateTime.Now}\t Exception: Loi");
                if (dcu != null) await Update_Status(dcu, STATUS.Offline);
            }
        }
        #endregion

        #region HÀM LẶP GỬI NHẬN DỮ LIỆU
        public async Task<int> ProcessDataLoop(clientmanagerV4 dcu)
        {
            dcu.IsProcessLoopRunning = true;
            byte[] recvBuffer = new byte[256];
            amountRead = 0;
            dcu.retry = 0; //nguyennvp 
            string hexString;
            var diemDo = new DIEMDO();
            try
            {
                var stream = dcu.tcpClient.GetStream();
                dcu.mStation.STATUS = STATUS.Online;
                clsRFSpider.meter_info = new clsRFSpider.MeterInfor(); // khởi tạo lại bộ chỉ số công tơ
                clsRFSpider.meter_info.init();
                dcu.diemDos = clsGeneral.GetAllDiemDoList(dcu);
                var amountReadTask = stream.ReadAsync(dcu.dataReceived, 0, dcu.dataReceived.Length);//nhận dữ liệu từ TCP
                while (true)
                {
                    var timeoutTask = Task.Delay(TimeSpan.FromSeconds(300));
                    var completedTask = await Task.WhenAny(timeoutTask, amountReadTask, dcu.cts.Task).ConfigureAwait(false);//đợi 1 trong 3 task hoàn thành
                    //Xử lý các tình huống timeout, hủy bỏ và lỗi
                    if (completedTask == timeoutTask)
                    {
                        if (dcu.Event != EVENT.READ_ALL && !dcu.isReading)
                        {
                            if (dcu.Event == EVENT.DISCOVERY)
                                AppendLog(ref dcu, true, true, "Đang trong tiến trình Khám phá, bỏ qua timeout", Color.Black, Color.Black);
                        }
                        else
                        {
                            AppendLog(ref dcu, true, true, "Đang trong tiến trình Đọc, bỏ qua timeout", Color.Black, Color.Black);
                        }
                        continue;
                    }
                    if (dcu.cts.Task.IsCanceled)
                    {
                        switch (dcu.Event)
                        {
                            case EVENT.READ_EVENT_ELSTER:
                            case EVENT.SETTING_LOAD_PROFILE:
                            case EVENT.READ_LOAD_PROFILE:
                            case EVENT.READ_EVENT:
                            case EVENT.READ_TARIFF:
                            case EVENT.READ_BILLING:
                            case EVENT.READ_ALL:
                                dcu.isDiscoveryChecked = false;
                                dcu.subIndex_event_elster = 0;
                                modem.sequence_number.sss = 0;
                                modem.sequence_number.rrr = 0;
                                dcu.discover_condition = 0;
                                dcu.isreread = false;
                                // Kiểm tra xem người dùng có đang chọn một dòng cụ thể trong GridView không
                                if (dcu.gridViewItem != null && dcu.gridViewItem.FocusedRowHandle >= 0)
                                {
                                    //Lấy danh sách từ dòng đang chọn đến hết
                                    clsGeneral.selectedlistdiemdo = clsGeneral.GetListFromSelectedRow(dcu);

                                    if (clsGeneral.selectedlistdiemdo != null && clsGeneral.selectedlistdiemdo.Count > 0)
                                    {
                                        dcu.diemDos = clsGeneral.selectedlistdiemdo;
                                    }
                                    else
                                    {
                                        // Nếu vì lý do nào đó danh sách rỗng, fallback về filteredlist
                                        dcu.diemDos = clsGeneral.filteredlistdiemdo;
                                    }
                                }
                                else
                                {
                                    //Nếu không chọn dòng nào → dùng danh sách mặc định
                                    dcu.diemDos = clsGeneral.filteredlistdiemdo;
                                }
                                await Task.Delay(500);
                                break;
                            case EVENT.DISCOVERY:
                                dcu.stopDiscovery = false;

                                // Bước 1: Kiểm tra một lần duy nhất khi bắt đầu Discovery
                                if (!dcu.isDiscoveryChecked)
                                {
                                    dcu.isDiscoveryChecked = true;

                                    var listToCheck = (dcu.gridViewItem != null && dcu.gridViewItem.FocusedRowHandle >= 0)
                                        ? clsGeneral.selectedlistdiemdo  // Có chọn hàng
                                        : clsGeneral.filteredlistdiemdo; // Không chọn hàng

                                    // Kiểm tra xem tất cả điểm đo đã có SPIDER_READ chưa
                                    if (listToCheck != null && listToCheck.Count > 0)
                                    {
                                        bool allHavePath = true;
                                        foreach (var dd in listToCheck)
                                        {
                                            if (string.IsNullOrWhiteSpace(dd.SPIDER_READ))
                                            {
                                                allHavePath = false;
                                                break;
                                            }
                                        }

                                        if (allHavePath)
                                        {
                                            string msg = $"Tất cả {listToCheck.Count} điểm đo đã tồn tại đường dẫn.\n\n" +
                                                         $"Vui lòng xóa đường dẫn cũ trước khi thực hiện khám phá lại.";

                                            System.Windows.Forms.MessageBox.Show(
                                                msg,
                                                "Cảnh báo - Đường dẫn đã tồn tại",
                                                System.Windows.Forms.MessageBoxButtons.OK,
                                                System.Windows.Forms.MessageBoxIcon.Warning
                                            );

                                            // Dừng tiến trình khám phá
                                            dcu.Event = EVENT.STOP;
                                            dcu.stopDiscovery = true;
                                            dcu.isReading = false;
                                            dcu.isRediscovery = false;
                                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                                            break;
                                        }
                                    }
                                }

                                // Bước 2: Xác định danh sách điểm đo cần khám phá
                                if (dcu.gridViewItem != null && dcu.gridViewItem.FocusedRowHandle >= 0)
                                {
                                    // Có chọn hàng → khám phá từ hàng được chọn
                                    dcu.diemDos = clsGeneral.GetListFromSelectedRow(dcu);
                                }
                                else
                                {
                                    // Không chọn hàng → khám phá toàn bộ
                                    dcu.diemDos = clsGeneral.GetListDiscovery(dcu);
                                }

                                // Bước 3: Kiểm tra và khởi tạo tiến trình khám phá
                                if (dcu.discover_condition == 0)
                                {
                                    dcu.totaldisco_diemdo = clsGeneral.GetTotalDiscoveryMeter(dcu);

                                    if (dcu.totaldisco_diemdo == 0)
                                    {
                                        AppendLog(ref dcu, true, true,
                                            "Không có điểm đo nào cần khám phá!",
                                            Color.Blue, Color.Black);
                                        dcu.Event = EVENT.STOP;
                                        dcu.stopDiscovery = true;
                                        dcu.isReading = false;
                                        ReadingCompleted?.Invoke(this, EventArgs.Empty);
                                        break;
                                    }

                                    dcu.maxretry = 3;
                                    AppendLog(ref dcu, true, true,
                                        "Bắt đầu tiến trình Khám phá đường dẫn",
                                        Color.Blue, Color.Blue);
                                }
                                break;
                            case EVENT.STOP:
                                dcu.discover_condition = 0;
                                dcu.isDiscoveryChecked = false;
                                dcu.isReading = false;
                                dcu.isreread = false;
                                dcu.rediscoveredSuccessList = new List<DIEMDO>();
                                await Task.Delay(200);
                                break;
                            default:
                                dcu.isReading = false;
                                break;
                        }
                        dcu.failedDiemDos = new List<DIEMDO>(); // reset nếu có
                        dcu.set_index(0, 0, 0, 0, 0, 0, 0, -1, -1, 0, -1, 0);
                        dcu.hasLoggedSuccess = false;
                        Console.WriteLine($"{DateTime.Now.ToString()}\t Event  = {dcu.Event.ToString()}");
                        dcu.cts = new TaskCompletionSource<object>();
                        if (dcu.Event != EVENT.STOP)
                        {
                            await ProcessEvent(stream, amountReadTask, dcu);
                        }
                        await Task.Delay(200);
                        continue;
                    }
                    if (amountReadTask.IsFaulted || amountReadTask.IsCanceled)
                    {
                        Console.WriteLine($"{DateTime.Now.ToString()}\t AmountReadTask is fault {amountReadTask.Exception}");
                        break;
                    }
                    amountRead = await amountReadTask.ConfigureAwait(false);
                    if (amountRead == 0)
                    {
                        Console.WriteLine($"{DateTime.Now}\t AmountReadTask is empty");
                        throw new IOException("Client disconnected");
                        //break;
                    }

                    #region NHẬN CÁC LỆNH AT ĐỐI VỚI DCU1P
                    //NHẬN CÁC LỆNH AT ĐỐI VỚI DCU1P
                    if (dcu.isReadingAT || dcu.Event == EVENT.PUSH || dcu.Event == EVENT.INFOR_DDO || dcu.Event == EVENT.PUSH_SETTING)
                    {
                        dcu.receivedData = dcu.dataReceived.AsMemory(0, amountRead);
                        hexString = BitConverter.ToString(dcu.receivedData.Span.ToArray()).Replace("-", "");
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\t{hexString}", Color.Blue, Color.Blue);
                        clsGeneral.AT_ReceivedData = dcu.receivedData;
                        await Task.Delay(50);
                        amountReadTask = stream.ReadAsync(dcu.dataReceived, 0, dcu.dataReceived.Length); // tiếp tục đọc
                        if (dcu.Event == EVENT.PUSH)
                        {
                            if (dcu.receivedData.Span[13] == 0x06)
                            {
                                AppendLog(ref dcu, false, true, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\tĐã ghi số serial công tơ: {SerialID}", Color.Blue, Color.Blue);
                            }
                            else
                            {
                                AppendLog(ref dcu, false, true, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\tGhi số serial thất bại", Color.Red, Color.Red);
                            }
                        }
                        if (dcu.Event == EVENT.PUSH_SETTING)
                        {
                            if (dcu.receivedData.Span[13] == 0x06)
                            {
                                AppendLog(ref dcu, false, true, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\tCài đặt thời gian đặt thành công", Color.Blue, Color.Blue);
                            }
                            else
                            {
                                AppendLog(ref dcu, false, true, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\tCài đặt thời gian thất bại", Color.Red, Color.Red);
                            }
                        }
                        if (dcu.Event == EVENT.INFOR_DDO)//THêm công tơ vào DCU push
                        {
                            byte[] bytes = dcu.receivedData.Span.ToArray();
                            int offset = 12; // Bỏ qua CMD_HEADER (8) + 0x68 + LEN + CMD (2)
                            while (offset + 5 <= bytes.Length - 2)
                            {
                                byte[] serialBytes = new byte[4];
                                Array.Copy(bytes, offset + 1, serialBytes, 0, 4);
                                uint serial = BitConverter.ToUInt32(serialBytes, 0);
                                byte meterType = bytes[offset + 5];// 1 byte meter type
                                string meterTypeName = meterType switch
                                {
                                    0x01 => "DT01PRF",//byte chủng loại
                                    0x02 => "DDS26D",
                                    0x03 => "DT03RF",
                                    _ => $"Unknown (0x{meterType:X2})"
                                };

                                AppendLog(ref dcu, true, true,
                                    $"Serial: {serial}, Loại công tơ: {meterTypeName}",
                                    Color.DarkCyan, Color.Empty);
                                offset += 5;
                            }
                        }
                        continue;
                    }
                    //////////////////////////
                    #endregion

                    else
                    {
                        string asciiCmd = await ReceiveAndProcessData(dcu, dcu.dataReceived);
                        dcu.asciicmd_mahoa = asciiCmd;
                        //Duy trì kết nối mỗi 2p
                        if (asciiCmd.Contains(dcu.mStation.IMEI) && asciiCmd.Contains(dcu.mStation.MASTER_ID.ToString()))
                        {
                            await stream.WriteAsync(clsGeneral.CMD_OK, 0, clsGeneral.CMD_OK.Length);
                            AppendLog(ref dcu, true, false, $"\r\n{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsGeneral.CMD_OK).Replace("-", "")}", Color.Red, Color.Red);
                            AppendLog(ref dcu, true, false, $"\r\n{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT}\t===>\t{Encoding.ASCII.GetString(clsGeneral.CMD_OK)}", Color.Red, Color.Red);
                            asciiCmd = "";
                            amountReadTask = stream.ReadAsync(dcu.dataReceived, 0, dcu.dataReceived.Length);
                            continue;
                        }
                        //////////////////////

                        clsRFSpider.fromid = dcu.masterID;
                        (decimal cs_moi, string cs_string, int rssi) = clsData.AnalyzeCmd(dcu.cmds.serial, dcu.cmds.cmd_rf, dcu.cmds.sub_cmd, dcu.cmds.path, dcu.cmds.metertype, dcu.cmds.protocolRF, dcu.receivedData.ToArray(), dcu);
                        if (!dcu.KetQuaChiSoMoi.ContainsKey(dcu.cmds.cmd_rf))
                        {
                            dcu.KetQuaChiSoMoi[dcu.cmds.cmd_rf] = new List<ChiSoResult>();
                        }
                        dcu.KetQuaChiSoMoi[dcu.cmds.cmd_rf].Add(new ChiSoResult
                        {
                            GiaTriSo = cs_moi >= 0 ? cs_moi : -1,
                            GiaTriChuoi = !string.IsNullOrEmpty(cs_string) ? cs_string : null
                        });
                        dcu.KetQuaRSSI[dcu.cmds.cmd_rf] = rssi;
                        switch (dcu.Event)
                        {
                            case EVENT.PUSH:
                            case EVENT.READ_WITHOUT_TSVH:
                            case EVENT.READ_HAVE_TSVH:
                            case EVENT.READ_FAILs:
                            case EVENT.READ_ALL:
                                await HandleReadAllAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.READ_BILLING:
                                await HandleReadBillingAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.READ_EVENT:
                                await HandleReadEventAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.READ_TARIFF:
                                await HandleReadTariffAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.READ_TSVH:
                                await HandleReadTSVHAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.READ_ONE:
                                await HandleReadOneAsync(dcu, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.DISCOVERY:
                                //await HandleDiscoveryAsync(dcu, diemDo, dcu.diemDos, stream, amountReadTask, cs_moi, cs_string, rssi);
                                if (dcu.dt != null && dcu.currentindex >= 0 && dcu.currentindex < dcu.diemDos.Count)
                                {
                                    diemDo = dcu.diemDos[dcu.currentindex];
                                    if (clsData.listcmdChiso.Contains(dcu.cmds.cmd_rf))
                                    {
                                        await Update_Chiso(diemDo, clsRFSpider.meter_info);
                                    }
                                }
                                //kiểm tra chỉ số
                                if (cs_moi != -1) // đọc thành công điểm đo
                                {
                                    dcu.subIndex++; // tăng cmd đọc
                                    dcu.retry = 0; // set lại biến retry cho lượt đọc mới 
                                    if (dcu.subIndex > dcu.maxsubIndex)
                                    {
                                        //dcu.success_disco_path = dcu.current_disco_path; // gán giá trị đường dẫn đọc thành công
                                        // sắp xếp lại đường dẫn
                                        string spider_path_in_grid = diemDo.SPIDER_PATH;
                                        if (diemDo.METER_TYPE == clsHU.METER_TYPE.DT01P80RF.ToString() && diemDo.MESH == true) clsRFSpider.meter_info.rssidBm = clsHU.calcRSSIdBm(clsRFSpider.meter_info.rssi_meter);

                                        bool mesh_status = false;
                                        if (dcu.discover_condition <= 1) // loại ROUTER, MESH 
                                            mesh_status = true;
                                        switch (mesh_status)
                                        {
                                            case true:
                                                if (clsGeneral.check_exists_path(ref spider_path_in_grid, dcu.current_disco_path, mesh_status, clsRFSpider.meter_info.rssidBm, clsRFSpider.meter_info.level, dcu.pa_flag) == true)
                                                {
                                                    diemDo.SPIDER_PATH = spider_path_in_grid;
                                                    diemDo.SPIDER_LEVEL = clsRFSpider.meter_info.level;
                                                    //thuc hien sort duong dan theo rssi
                                                    diemDo.SPIDER_PATH = clsGeneral.GetSort_Path(clsGeneral.cut_path(diemDo.SPIDER_PATH, clsGeneral.spiderpath_node_max));
                                                    string[] paths = diemDo.SPIDER_PATH.Split(new char[] { '/' });
                                                    if (paths.Length > 0)
                                                        diemDo.SPIDER_READ = dcu.success_disco_path = paths[0];
                                                    else
                                                        diemDo.SPIDER_READ = dcu.success_disco_path = diemDo.SPIDER_PATH;
                                                }
                                                break;
                                            case false:
                                                if (clsGeneral.check_exists_path(ref spider_path_in_grid, dcu.current_disco_path, mesh_status, clsRFSpider.meter_info.rssidBm, clsRFSpider.meter_info.level, dcu.pa_flag) == true)
                                                {
                                                    diemDo.SPIDER_PATH = spider_path_in_grid;
                                                    diemDo.SPIDER_LEVEL = clsRFSpider.meter_info.level;
                                                    //thuc hien sort duong dan theo rssi
                                                    diemDo.SPIDER_PATH = clsGeneral.GetSort_rssi(clsGeneral.cut_path(diemDo.SPIDER_PATH, clsGeneral.spiderpath_node_max));
                                                    string[] paths = diemDo.SPIDER_PATH.Split(new char[] { '/' });
                                                    if (paths.Length > 0)
                                                        diemDo.SPIDER_READ = paths[0];
                                                    else
                                                        diemDo.SPIDER_READ = diemDo.SPIDER_PATH;
                                                    string[] path_temps = diemDo.SPIDER_READ.Split(new char[] { ':' });
                                                    string path_temp = path_temps[0]; // bỏ phần từ sau :
                                                    string[] path_temp1 = path_temp.Split(new char[] { ';' }); // lấy các note
                                                    if ((path_temp1.Length > 1) && (path_temp1[path_temp1.Length - 1] == diemDo.SERY_CTO))
                                                    {
                                                        if (path_temp1.Length > 2)
                                                            dcu.success_disco_path = string.Join(" ", new ArraySegment<string>(path_temp1, 0, path_temp1.Length - 2));
                                                        else
                                                            dcu.success_disco_path = path_temp1[0];
                                                    }
                                                }
                                                break;
                                        }

                                        //
                                        AppendLog(ref dcu, true, true, String.Format("Discovery thành công điểm đo chủng loại <{0}>, serial <{1}>, path = {2}; RSSI = {3}; kWhImport = {4}", diemDo.METER_TYPE, diemDo.SERY_CTO, dcu.success_disco_path, clsRFSpider.meter_info.rssidBm.ToString(), clsRFSpider.meter_info.kWhImport.ToString()), Color.Green, Color.Green);

                                        if (dcu.isRediscovery == true)
                                        {
                                            if (!dcu.rediscoveredSuccessList.Contains(diemDo))
                                                dcu.rediscoveredSuccessList.Add(diemDo);
                                        }
                                        dcu.successdisco_diemdo++;
                                        Save_Json_Result(dcu, diemDo, clsRFSpider.meter_info, true);
                                        dcu.KetQuaChiSoMoi.Clear();
                                        dcu.KetQuaRSSI.Clear();
                                        dcu.subIndex = 0;
                                        dcu.discovery_path_level = 0;
                                        dcu.currentindex++; // chuyển điểm đo
                                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor(); // khởi tạo lại bộ chỉ số công tơ
                                        clsRFSpider.meter_info.init();
                                        if (dcu.currentindex > dcu.diemDos.Count - 1) // nếu là điểm đo cuối thì tăng level discovery
                                        {
                                            dcu.discovery_level++;
                                            try
                                            {
                                                dcu.discovery_lever_max = dcu.dt.Max(x => x.SPIDER_LEVEL); // chưa ổn, xem lại lấy lại từ lưới
                                            }
                                            catch { }
                                            dcu.currentindex = 0; // set lại current index để chạy 
                                            dcu.previousIndex = -1;
                                            if (dcu.gridViewItem != null && dcu.gridViewItem.FocusedRowHandle >= 0)
                                            {
                                                var selectedList = clsGeneral.GetListFromSelectedRow(dcu);
                                                if (selectedList != null && selectedList.Count > 0)
                                                {
                                                    // Tách điểm chưa có SPIDER_READ
                                                    var failedInSelected = selectedList.Where(dd => string.IsNullOrWhiteSpace(dd.SPIDER_READ)).ToList();

                                                    if (failedInSelected.Count == 0)
                                                    {
                                                        // TẤT CẢ ĐÃ THÀNH CÔNG
                                                        AppendLog(ref dcu, true, true,
                                                            $"Tất cả {selectedList.Count} điểm đo từ hàng chọn đã có đường dẫn. Kết thúc khám phá.",
                                                            Color.Blue, Color.OrangeRed);
                                                        dcu.Event = EVENT.STOP;
                                                        dcu.stopDiscovery = true;
                                                        dcu.isReading = false;
                                                        dcu.reset_all();
                                                        ReadingCompleted?.Invoke(this, EventArgs.Empty);
                                                        break;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                if (dcu.discovery_level > dcu.discovery_lever_max) // nếu là level cuối thì chuyển mesh meter lever tiếp theo
                                                {
                                                    dcu.discovery_meter_mesh_level++;
                                                    //reset lại các giá trị
                                                    dcu.discovery_level = 0;
                                                    if (dcu.discovery_meter_mesh_level > dcu.discovery_meter_mesh_level_max) // nếu là mesh lever cuối thì tăng condition
                                                    {
                                                        dcu.discover_condition++;
                                                        dcu.discovery_meter_mesh_level = 0;//reset
                                                    }
                                                }
                                                dcu.diemDos = clsGeneral.GetListDiscovery(dcu); // lấy danh sách discovery để bỏ những điểm đã có đường dẫn
                                            }
                                        }
                                    }
                                    await SendRefreshCommands(dcu, stream, diemDo);//chuyển tần số về 408
                                }
                                else if (cs_moi == -1)
                                {
                                    dcu.retry++; // tăng retry để đọc lại cmd
                                    if (dcu.retry > dcu.maxretry) // hết lượt retry => chuyển pathrf tiếp theo
                                    {
                                        dcu.discovery_path_level++;
                                        dcu.retry = 0;
                                        await SendRefreshCommands(dcu, stream, diemDo);//chuyển tần số về 408
                                        if (dcu.discovery_path_level > dcu.discovery_path_level_max) // nếu là path cuối thì chuyển điểm đo
                                        {
                                            AppendLog(ref dcu, true, true, String.Format("Discovery thất bại điểm đo chủng loại <{0}>, serial <{1}>", diemDo.METER_TYPE, diemDo.SERY_CTO), Color.Red, Color.Red); dcu.KetQuaChiSoMoi.Clear();
                                            dcu.KetQuaRSSI.Clear();
                                            dcu.currentindex++;
                                            //reset lại các biến của 1 điểm đo                                           
                                            dcu.subIndex = 0;
                                            dcu.discovery_path_level = 0;
                                            clsRFSpider.meter_info = new clsRFSpider.MeterInfor(); // khởi tạo lại bộ chỉ số công tơ
                                            clsRFSpider.meter_info.init();

                                            if (dcu.currentindex > dcu.diemDos.Count - 1) // nếu là điểm đo cuối thì tăng level discovery
                                            {
                                                //CHIA 2 TRƯỜNG HỢP
                                                if (dcu.gridViewItem != null && dcu.gridViewItem.FocusedRowHandle >= 0)
                                                {
                                                    // ========== CASE 1: HÀNG CHỌN ==========
                                                    var selectedList = clsGeneral.GetListFromSelectedRow(dcu);
                                                    if (selectedList != null && selectedList.Count > 0)
                                                    {
                                                        var failedInSelected = selectedList.Where(dd => string.IsNullOrWhiteSpace(dd.SPIDER_READ)).ToList();

                                                        if (failedInSelected.Count == 0)
                                                        {
                                                            AppendLog(ref dcu, true, true,
                                                                $"Tất cả {selectedList.Count} điểm đo từ hàng chọn đã có đường dẫn. Kết thúc khám phá.",
                                                                Color.Blue, Color.OrangeRed);
                                                            dcu.Event = EVENT.STOP;
                                                            dcu.stopDiscovery = true;
                                                            dcu.isReading = false;
                                                            dcu.reset_all();
                                                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                                                        }
                                                        else if (dcu.discovery_level > dcu.discovery_lever_max)
                                                        {
                                                            AppendLog(ref dcu, true, true,
                                                                $"Hết level discovery. Có {failedInSelected.Count} điểm đo thất bại. Bắt đầu đọc lại các điểm đó...",
                                                                Color.DarkOrange, Color.DarkOrange);

                                                            dcu.diemDos = failedInSelected;
                                                            dcu.currentindex = 0;
                                                            dcu.subIndex = 0;
                                                            dcu.previousIndex = -1;
                                                            dcu.discovery_path_level = 0;
                                                            dcu.isRediscovery = true;
                                                            dcu.discovery_meter_mesh_level++;
                                                            dcu.discovery_level = 0;

                                                            if (dcu.discovery_meter_mesh_level > dcu.discovery_meter_mesh_level_max)
                                                            {
                                                                dcu.discover_condition++;
                                                                dcu.discovery_meter_mesh_level = 0;
                                                            }

                                                            dcu.cts.TrySetCanceled();
                                                        }
                                                        else
                                                        {
                                                            dcu.discovery_level++;
                                                            dcu.currentindex = 0;
                                                            dcu.previousIndex = -1;
                                                            dcu.diemDos = failedInSelected;
                                                            dcu.cts.TrySetCanceled();
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    dcu.discovery_level++;
                                                    dcu.currentindex = 0; // set lại current index để chạy 
                                                    dcu.previousIndex = -1;
                                                    if (dcu.discovery_level > dcu.discovery_lever_max) // nếu là level cuối thì chuyển mesh meter lever tiếp theo
                                                    {
                                                        dcu.discovery_meter_mesh_level++;
                                                        //reset lại các giá trị
                                                        dcu.discovery_level = 0;
                                                        AppendLog(ref dcu, true, true, String.Format("Discovery thất bại điểm đo chủng loại <{0}>, serial <{1}>", diemDo.METER_TYPE, diemDo.SERY_CTO), Color.Red, Color.Red);
                                                        if (dcu.discovery_meter_mesh_level > dcu.discovery_meter_mesh_level_max) // nếu là mesh lever cuối thì tăng condition
                                                        {
                                                            clsGeneral.mclient_sel.OnDiscoveryCompleted?.Invoke();
                                                            clsGeneral.mclient_sel.OnDiscoveryCompleted = null; // tránh lặp lại

                                                            AppendLog(ref dcu, true, true, String.Format("Discovery thất bại điểm đo chủng loại <{0}>, serial <{1}>", diemDo.METER_TYPE, diemDo.SERY_CTO), Color.Red, Color.Red);
                                                            dcu.discover_condition++;
                                                            dcu.discovery_meter_mesh_level = 0;//reset
                                                            dcu.discovery_level = 0;
                                                            if (dcu.isRediscovery)
                                                            {
                                                                dcu.isreread = true;
                                                                dcu.isRediscovery = false;
                                                            }
                                                        }
                                                    }
                                                    dcu.diemDos = clsGeneral.GetListDiscovery(dcu); // lấy danh sách discovery để bỏ những điểm đã có đường dẫn
                                                }                                          
                                            }
                                        }

                                        else
                                        {
                                            AppendLog(ref dcu, true, true, String.Format("Discovery thất bại điểm đo chủng loại <{0}>, serial <{1}>", diemDo.METER_TYPE, diemDo.SERY_CTO), Color.Red, Color.Red); dcu.KetQuaChiSoMoi.Clear();
                                        }
                                    }
                                    else
                                    {
                                        AppendLog(ref dcu, true, false, String.Format("Retry lần {0}", dcu.retry), Color.DarkGray, Color.DarkGray);
                                    }
                                }
                                await ProcessEvent(stream, amountReadTask, dcu);
                                break;
                            case EVENT.MANUAL:
                                await HandleManualAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.READ_EVENT_ELSTER:
                                await HandleEvent_ELSTERAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.READ_LOAD_PROFILE:
                                await HandleLoadProfileAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.SETTING_LOAD_PROFILE:
                                await HandlesettingLoadProfileAsync(dcu, diemDo, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.READ_ROUTER_3P_CONFIG:
                                await HandleReadConfigRouter3PAsync(dcu, stream, amountReadTask, cs_moi, cs_string, rssi);
                                break;
                            case EVENT.STOP:
                                dcu.discover_condition = 1;
                                dcu.isReading = false;
                                dcu.cts.TrySetCanceled();//moi them 19/8
                                dcu.cts = new TaskCompletionSource<object>();
                                dcu.previousIndex = -1;//
                                await Update_Status(dcu, STATUS.Online);
                                if (dcu?.mStation != null)
                                {
                                    if (dcu.mStation.STATUS == STATUS.Online)
                                    {
                                        dcu.mStation.COUNTER_CONNECTED_times++;
                                    }
                                    else
                                    {
                                        dcu.mStation.COUNTER_DISCONNECTED++;
                                    }
                                    dcu.mStation.COUNTER_READCYCLE++;
                                    int idx = clsGeneral.stationBindingList.IndexOf(dcu.mStation);
                                    if (idx >= 0) clsGeneral.stationBindingList.ResetItem(idx);
                                }
                                ReadingCompleted?.Invoke(this, EventArgs.Empty);
                                break;
                            default:
                                break;
                        }
                        if (amountReadTask.IsCompleted)
                        {
                            Array.Clear(dcu.dataReceived, 0, dcu.dataReceived.Length);
                            amountReadTask = stream.ReadAsync(dcu.dataReceived, 0, dcu.dataReceived.Length);
                            //continue;
                        }

                        if (!stream.CanRead)
                        {
                            Console.WriteLine($"{DateTime.Now}\t Stream no longer readable");
                            break;
                        }
                    }
                }
            }
            catch (IOException ioex)
            {
                AppendLog(ref dcu, true, true, $"Mất kết nối tới DCU: {ioex.Message}", Color.Red, Color.Red);
            }
            catch (ObjectDisposedException)
            {
                AppendLog(ref dcu, true, true, $"Socket đã bị đóng, dừng tiến trình đọc.", Color.Red, Color.Red);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"{DateTime.Now}\t Exception in ProcessDataLoop: {ex.Message}");

                dcu.Event = EVENT.STOP;
                dcu.isReading = false;
            }
            finally
            {
                dcu.isReading = false;
                dcu.IsProcessLoopRunning = false;
                dcu.Event = EVENT.STOP;
            }
            return 1;
        }
        private async Task<int> ProcessEvent(NetworkStream stream, Task<int> amountReadTask, clientmanagerV4 dcu)
        {
            try
            {
                var diemDo = new DIEMDO();
                clsRFSpider.METER_TYPE meterType = new clsRFSpider.METER_TYPE();
                string versionRF;
                string meterTypeToUse;
                string hexSend;
                string path_read;
                string str;
                string hexString;
                byte[] recvBuffer = new byte[256];
                List<byte> commandList;
                List<byte[]> commandListbyte;
                string asciiCmd;
                switch (dcu.Event)
                {
                    case EVENT.PUSH_SETTING:
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        clsData dataInstance = new clsData();
                        commandListbyte = dataInstance.init_push_setting(push_time_start, push_retry_time_list, push_retry_time_ddo, push_read_times_day, push_max_time);
                        AppendLog(ref dcu, true, true, "Cấu hình thời gian đọc công tơ!", Color.Black, Color.Black);
                        foreach (var sendCmd in commandListbyte)
                        {
                            await stream.WriteAsync(sendCmd, 0, sendCmd.Length);
                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmd).Replace("-", "")}", Color.Red, Color.Red);
                        }
                        dcu.isReading = false;
                        break;
                    case EVENT.PUSH: //GHI DANH SÁCH VÀO DCU PUSH
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        dataInstance = new clsData();
                        commandListbyte = dataInstance.init_cmd_push(SerialID);
                        AppendLog(ref dcu, true, true, "Ghi danh sách công tơ!", Color.Black, Color.Black);
                        foreach (var sendCmd in commandListbyte)
                        {
                            await stream.WriteAsync(sendCmd, 0, sendCmd.Length);
                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmd).Replace("-", "")}", Color.Red, Color.Red);
                        }
                        AppendLog(ref dcu, true, true, "Đã ghi danh sách công tơ mới!", Color.DarkSeaGreen, Color.DarkSeaGreen);
                        dcu.isReading = false;
                        break;
                    case EVENT.INFOR_DDO: //ĐỌC DANH SÁCH DCU PUSH
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        byte[] sendCmd1 = clsData.init_cmd_custom_packet1();
                        AppendLog(ref dcu, true, true, "Ghi danh sách công tơ!", Color.Black, Color.Black);
                        await stream.WriteAsync(sendCmd1, 0, sendCmd1.Length);
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmd1).Replace("-", "")}", Color.Red, Color.Red);
                        AppendLog(ref dcu, true, true, "Đã ghi danh sách công tơ mới!", Color.DarkSeaGreen, Color.DarkSeaGreen);
                        dcu.isReading = false;
                        break;
                    case EVENT.READ_FAILs:
                        dcu.diemDos = dcu.GetFailedDataDiemDos(dcu);
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào cần đọc lại!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        dcu.currentindex = 0;
                        dcu.failedDiemDos = new List<DIEMDO>(); // reset nếu có
                        dcu.retryFailedCount = 0;
                        dcu.subIndex = 0;
                        dcu.maxsubIndex = 0;
                        dcu.previousIndex = -1;
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        dcu.Event = EVENT.READ_ALL; // tái sử dụng tiến trình READ_ALL để đọc lại
                        AppendLog(ref dcu, true, true, $"Đang đọc lại {dcu.diemDos.Count} điểm đo chưa có dữ liệu...", Color.DarkOrange, Color.Black);
                        await ProcessEvent(stream, amountReadTask, dcu);
                        break;
                    case EVENT.READ_HAVE_TSVH:
                        dcu.diemDos = dcu.Get_TSVH_Data_DiemDos(dcu);
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào cần đọc lại!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        dcu.currentindex = 0;
                        dcu.failedDiemDos = new List<DIEMDO>(); // reset nếu có
                        dcu.retryFailedCount = 0;
                        dcu.subIndex = 0;
                        dcu.maxsubIndex = 0;
                        dcu.previousIndex = -1;
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        dcu.Event = EVENT.READ_ALL;
                        AppendLog(ref dcu, true, true, $"Đang đọc lại {dcu.diemDos.Count} điểm đo chưa có dữ liệu...", Color.DarkOrange, Color.Black);
                        await ProcessEvent(stream, amountReadTask, dcu);
                        break;
                    case EVENT.READ_WITHOUT_TSVH:
                        dcu.diemDos = dcu.Get_TSVH_No_DiemDos(dcu);
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào cần đọc lại!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        dcu.currentindex = 0;
                        dcu.failedDiemDos = new List<DIEMDO>(); // reset nếu có
                        dcu.retryFailedCount = 0;
                        dcu.subIndex = 0;
                        dcu.maxsubIndex = 0;
                        dcu.previousIndex = -1;
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        dcu.Event = EVENT.READ_ALL;
                        AppendLog(ref dcu, true, true, $"Đang đọc lại {dcu.diemDos.Count} điểm đo chưa có dữ liệu...", Color.DarkOrange, Color.Black);
                        await ProcessEvent(stream, amountReadTask, dcu);
                        break;
                    case EVENT.REFRESH_FRE:
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        dataInstance = new clsData();
                        commandListbyte = dataInstance.init_cmd_send_fre();
                        AppendLog(ref dcu, true, true, "Gửi thông điệp làm mới!", Color.Black, Color.Black);
                        foreach (var sendCmd in commandListbyte)
                        {
                            await stream.WriteAsync(sendCmd, 0, sendCmd.Length);
                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmd).Replace("-", "")}", Color.Red, Color.Red);

                            recvBuffer = new byte[256];
                            amountRead = await stream.ReadAsync(recvBuffer, 0, recvBuffer.Length);

                            dcu.receivedData = recvBuffer.AsMemory(0, amountRead);
                            str = Encoding.Latin1.GetString(dcu.receivedData.Span);
                            hexString = BitConverter.ToString(dcu.receivedData.Span.ToArray()).Replace("-", "");

                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\t{hexString}", Color.Blue, Color.Blue);

                            await Task.Delay(500);
                        }
                        AppendLog(ref dcu, true, true, "Đã gửi thông điệp làm mới!", Color.DarkSeaGreen, Color.DarkSeaGreen);
                        dcu.isReading = false;
                        break;
                    case EVENT.READ_EVENT_ELSTER:
                        {
                            if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                            {
                                dcu.isReading = false;
                                dcu.status = STATUS.Online.ToString();
                                if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                                    clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;

                                AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                                dcu.Event = EVENT.STOP;
                                ReadingCompleted?.Invoke(this, EventArgs.Empty);
                                break;
                            }
                            dcu.isReading = true;
                            dcu.status = STATUS.Reading.ToString();
                            if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                                clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                            diemDo = dcu.diemDos[dcu.currentindex];
                            versionRF = diemDo.VERSION_RF ?? "";
                            meterTypeToUse = diemDo.METER_TYPE;
                            meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                            string data_analyze = "";
                            string strp2 = string.Empty;
                            switch (dcu.subIndex)
                            {
                                case 0: // logoff
                                    await stream.WriteAsync(clsData.cmdLogoff, 0, clsData.cmdLogoff.Length);
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdidok).Replace("-", "")}", Color.Red, Color.Red);
                                    asciiCmd = Encoding.ASCII.GetString(clsData.cmdLogoff);
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    await Task.Delay(500);
                                    break;
                                case 1: // cmdRequire
                                    await stream.WriteAsync(clsData.cmdRequire, 0, clsData.cmdRequire.Length);
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdRequire).Replace("-", "")}", Color.Red, Color.Red);
                                    asciiCmd = Encoding.ASCII.GetString(clsData.cmdRequire).Trim('\r', '\n');
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    break;
                                case 2: // cmdP0
                                    modem.indexPacket = 0;
                                    modem.indexDay = 1;
                                    await stream.WriteAsync(clsData.cmdP0, 0, clsData.cmdP0.Length);
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdP0).Replace("-", "")}", Color.Red, Color.Red);
                                    asciiCmd = Encoding.ASCII.GetString(clsData.cmdP0).Trim('\r', '\n');
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    break;
                                case 3: // P2
                                    analyze_programming_message(dcu.asciicmd_mahoa, ref data_analyze);
                                    string calp2Result = calp2("M_KH_DOC", data_analyze); //hoac FEDC0003
                                    strp2 = get_programming_message('P', '2', "(" + calp2Result + ")");
                                    byte[] commandBytes = Encoding.GetEncoding("iso-8859-1").GetBytes(strp2);
                                    commandQueue.Insert(modem.seq, new command("P2", commandBytes, true, new byte[] { clsAscii.ACK }, false));

                                    await stream.WriteAsync(commandBytes, 0, commandBytes.Length);
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(commandBytes).Replace("-", "")}", Color.Red, Color.Red);
                                    asciiCmd = Encoding.ASCII.GetString(commandBytes);
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    break;
                                case 4: // cmdEvent_elster                                   
                                    byte[] cmd = cmdSecurities[dcu.subIndex_event_elster];
                                    await stream.WriteAsync(cmd, 0, cmd.Length);
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(cmd).Replace("-", "")}", Color.Red, Color.Red);
                                    asciiCmd = Encoding.ASCII.GetString(cmd);
                                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    break;
                                default:
                                    // kết thúc hoặc các lệnh khác
                                    break;
                            }
                        }
                        break;
                    case EVENT.SETTING_LOAD_PROFILE:
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.isReading = false;
                            dcu.status = STATUS.Online.ToString(); // Mặc định Online nếu vẫn kết nối
                            if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                            clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        //gửi idokokok
                        if (dcu.subIndex == 0)
                        {
                            await stream.WriteAsync(clsData.cmdidok, 0, clsData.cmdidok.Length);
                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdidok).Replace("-", "")}", Color.Red, Color.Red);
                            asciiCmd = Encoding.ASCII.GetString(clsData.cmdidok);
                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                            await Task.Delay(2000);
                        }
                        diemDo = dcu.diemDos[dcu.currentindex];
                        BDPT_METERTYPE = bdpt_metertype;
                        commandListbyte = clsData.GetCommandListBy_setting_BDPT(clsData.BDPT_METERTYPE);
                        dcu.maxsubIndex = commandListbyte.Count;
                        var sendCmdLP = commandListbyte[dcu.subIndex];
                        await stream.WriteAsync(sendCmdLP, 0, sendCmdLP.Length);
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmdLP).Replace("-", "")}", Color.Red, Color.Red);
                        asciiCmd = Encoding.ASCII.GetString(sendCmdLP);
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                        break;
                    case EVENT.READ_LOAD_PROFILE:
                        {
                            dcu.isReading = true;
                            dcu.status = STATUS.Reading.ToString();
                            if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                                clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                            diemDo = dcu.diemDos[dcu.currentindex];
                            versionRF = diemDo.VERSION_RF ?? "";
                            meterTypeToUse = diemDo.METER_TYPE;
                            meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                            string data_analyze = "";
                            string strp2 = string.Empty;
                            BDPT_METERTYPE = bdpt_metertype;

                            switch (dcu.subIndex)
                            {
                                case 0: // logoff
                                    if (BDPT_METERTYPE == "LANDISGYR")
                                    {
                                        byte[] logoffData = clsData.getCmdLogoff(modem, clsData.cmdLogoff_landis);
                                        await stream.WriteAsync(logoffData, 0, logoffData.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdidok).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdLogoff);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else //DT03MRF-DT01MRF
                                    {
                                        await stream.WriteAsync(clsData.cmdLogoff, 0, clsData.cmdLogoff.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdidok).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdLogoff);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    AppendLog(ref dcu, false, true, $"Đang đọc biểu đồ phụ tải công tơ. Vui lòng đợi...", Color.RosyBrown, Color.RosyBrown);
                                    await Task.Delay(500);
                                    break;

                                case 1: // cmdRequire
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR")
                                    {
                                        byte[] logonData = clsData.getCmdLogon(modem, clsData.cmdLogon);
                                        await stream.WriteAsync(logonData, 0, logonData.Length);
                                        modem.sequence_number.sss++;
                                        modem.sequence_number.rrr++;
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(logonData).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(logonData);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else
                                    {
                                        await stream.WriteAsync(clsData.cmdRequire, 0, clsData.cmdRequire.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdRequire).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdRequire).Trim('\r', '\n');
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    break;

                                case 2: // cmdP0
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR")
                                    {
                                        await stream.WriteAsync(clsData.cmdSerial_landis, 0, clsData.cmdSerial_landis.Length);
                                        modem.sequence_number.sss++;
                                        modem.sequence_number.rrr++;
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdSerial_landis).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdSerial_landis);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else
                                    {
                                        modem.indexPacket = 0;
                                        modem.indexDay = 1;
                                        await stream.WriteAsync(clsData.cmdP0, 0, clsData.cmdP0.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdP0).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdP0).Trim('\r', '\n');
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    break;

                                case 3: // P2
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR")
                                    {
                                        data_analyze = dcu.asciicmd_mahoa;

                                        get_llc_messages(modem, ref data_analyze);
                                        modem.versionmeter = clsConvert.ToString(data_analyze.Substring(data_analyze.Length - 6, 6));
                                        data_analyze = modem.versionmeter;
                                        if (data_analyze == "NSW") return -1;
                                        getShortName(ref modem);
                                        data_analyze = dcu.asciicmd_mahoa;
                                        get_llc_messages(modem, ref data_analyze);
                                        data_analyze = clsConvert.ToStringAscii(clsConvert.ToByteArray(data_analyze.Substring(16))).Replace("<NUL>", "");
                                        await stream.WriteAsync(clsData.cmdClock_landis, 0, clsData.cmdClock_landis.Length);
                                        modem.sequence_number.sss++;
                                        modem.sequence_number.rrr++;
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdClock_landis).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdClock_landis);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else if (clsData.BDPT_METERTYPE == "ELSTER")
                                    {
                                        analyze_programming_message(dcu.asciicmd_mahoa, ref data_analyze);
                                        string calp2Result = calp2("M_KH_DOC", data_analyze); //hoặc FEDC0003
                                        strp2 = get_programming_message('P', '2', "(" + calp2Result + ")");
                                        byte[] commandBytes = Encoding.GetEncoding("iso-8859-1").GetBytes(strp2);
                                        commandQueue.Insert(modem.seq, new command("P2", commandBytes, true, new byte[] { clsAscii.ACK }, false));

                                        await stream.WriteAsync(commandBytes, 0, commandBytes.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(commandBytes).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(commandBytes);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else
                                    {
                                        if (!clsData.analyze_password_message(dcu.asciicmd_mahoa, ref data_analyze)) return -1;
                                        string calp2Result = clsData.calp2("MK_MUC_3", data_analyze, 249);
                                        strp2 = clsData.get_programming_message('P', '2', "(" + calp2Result + ")");
                                        byte[] commandBytes = Encoding.GetEncoding("iso-8859-1").GetBytes(strp2);
                                        commandQueue.Insert(modem.seq, new command("P2", commandBytes, true, new byte[] { clsAscii.ACK }, false));

                                        await stream.WriteAsync(commandBytes, 0, commandBytes.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(commandBytes).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(commandBytes);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    break;
                                case 4: // cmdReadLoadConfig
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR")
                                    {
                                        data_analyze = dcu.asciicmd_mahoa;
                                        get_llc_messages(modem, ref data_analyze);
                                        data_analyze = data_analyze.Substring(10);
                                        getClock(data_analyze, ref pClock);
                                        modem.clock_meter_info = pClock;
                                        data_analyze = pClock.ToString("o");
                                        await stream.WriteAsync(clsData.cmdConstant_landis, 0, clsData.cmdConstant_landis.Length);
                                        modem.sequence_number.sss++;
                                        modem.sequence_number.rrr++;
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdConstant_landis).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdConstant_landis);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else if (clsData.BDPT_METERTYPE == "ELSTER")
                                    {
                                        modem.getLoadprofile = 0x0001;
                                        byte[] cmd = getCmdLoadprofile(modem.getLoadprofile);
                                        await stream.WriteAsync(cmd, 0, cmd.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(cmd).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(cmd);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else
                                    {
                                        await stream.WriteAsync(clsData.cmdReadLoadConfig, 0, clsData.cmdReadLoadConfig.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdReadLoadConfig).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdReadLoadConfig);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    break;

                                case 5: // maxDays
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR") //gói này bắt đầu vào load profile
                                    {
                                        for (byte i = 0; i < modem._shortName.loadprofile_shortname.Count; i++)
                                        {
                                            byte[] cmdBytes = getCmdMeter(modem._shortName.loadprofile_shortname[i], modem, COMMANDS.LOADPROFILECONFIG);
                                            if (modem.listcmdsend == null)
                                                modem.listcmdsend = new List<command>();
                                            modem.listcmdsend.Add(new command(COMMANDS.LOADPROFILECONFIG, cmdBytes, false, null, true));
                                            string hex = BitConverter.ToString(cmdBytes).Replace("-", " ");
                                            await stream.WriteAsync(cmdBytes, 0, cmdBytes.Length);
                                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(cmdBytes).Replace("-", "")}", Color.Red, Color.Red);
                                        }
                                    }
                                    else if (BDPT_METERTYPE == "ELSTER")
                                    {
                                        await stream.WriteAsync(cmdReadProfileRecord_elster, 0, cmdReadProfileRecord_elster.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(cmdReadProfileRecord_elster).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(cmdReadProfileRecord_elster);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else
                                    {
                                        if (!clsData.analyze_data_message(dcu.asciicmd_mahoa, ref data_analyze)) return -1;
                                        string strMaxday = data_analyze.Substring(12, 4);
                                        modem.maxDays = ushort.Parse(strMaxday.Substring(2, 2) + strMaxday.Substring(0, 2), NumberStyles.AllowHexSpecifier);
                                        if (modem.getLoadprofile >= modem.maxDays) modem.getLoadprofile = modem.maxDays;

                                        await stream.WriteAsync(clsData.cmdReadMaxRecordFirst, 0, clsData.cmdReadMaxRecordFirst.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(clsData.cmdReadMaxRecordFirst).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(clsData.cmdReadMaxRecordFirst);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    break;

                                case 6: // maxPackets
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR") //gói thứ 2 bắt đầu vào load profile
                                    {
                                        for (byte i = 0; i < modem._shortName.loadprofile_shortname.Count; i++)
                                        {
                                            byte[] cmdBytes = getCmdFollowup(ref modem);
                                            if (modem.listcmdsend == null)
                                                modem.listcmdsend = new List<command>();
                                            modem.listcmdsend.Add(new command(COMMANDS.LOADPROFILECONFIG, cmdBytes, false, null, true));

                                            // In ra hex string
                                            string hex = BitConverter.ToString(cmdBytes).Replace("-", " ");
                                            // Gửi ngay gói này đi
                                            await stream.WriteAsync(cmdBytes, 0, cmdBytes.Length);
                                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(cmdBytes).Replace("-", "")}", Color.Red, Color.Red);
                                        }
                                    }
                                    else if (BDPT_METERTYPE == "ELSTER")
                                    {
                                        if (!analyze_data_message(dcu.asciicmd_mahoa, ref data_analyze)) return -1;
                                        modem.maxPackets = ushort.Parse(data_analyze, NumberStyles.AllowHexSpecifier);

                                        byte[] loadProfileCmd = getCmdPacketLoad_elster(ref modem, cmdReadProfileValue_elster);
                                        commandQueue.Insert(modem.seq, new command(COMMANDS.LOADPROFILE, loadProfileCmd, false, new byte[] { clsAscii.ETX }, true));

                                        await stream.WriteAsync(loadProfileCmd, 0, loadProfileCmd.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(loadProfileCmd).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(loadProfileCmd);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    else
                                    {
                                        if (!clsData.analyze_data_message(dcu.asciicmd_mahoa, ref data_analyze)) return -1;
                                        modem.maxPackets = ushort.Parse(data_analyze.Substring(2, 2) + data_analyze.Substring(0, 2), NumberStyles.AllowHexSpecifier);

                                        byte[] loadProfileCmd = getCmdPacketLoad(ref modem, cmdReadProfileValue);
                                        commandQueue.Insert(modem.seq, new command(COMMANDS.LOADPROFILE, loadProfileCmd, false, new byte[] { clsAscii.ETX }, true));

                                        await stream.WriteAsync(loadProfileCmd, 0, loadProfileCmd.Length);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(loadProfileCmd).Replace("-", "")}", Color.Red, Color.Red);
                                        asciiCmd = Encoding.ASCII.GetString(loadProfileCmd);
                                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{asciiCmd}", Color.Red, Color.Red);
                                    }
                                    break;

                                case 7: // maxPackets
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR") //gói thứ 3 bắt đầu vào load profile
                                    {
                                        for (byte i = 0; i < modem._shortName.loadprofile_shortname.Count; i++)
                                        {
                                            byte[] cmdBytes = getCmdFollowup(ref modem);
                                            if (modem.listcmdsend == null)
                                                modem.listcmdsend = new List<command>();
                                            modem.listcmdsend.Add(new command(COMMANDS.LOADPROFILECONFIG, cmdBytes, false, null, true));

                                            // In ra hex string
                                            string hex = BitConverter.ToString(cmdBytes).Replace("-", " ");
                                            // Gửi ngay gói này đi
                                            await stream.WriteAsync(cmdBytes, 0, cmdBytes.Length);
                                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(cmdBytes).Replace("-", "")}", Color.Red, Color.Red);
                                        }
                                    }
                                    break;

                                case 8: // maxPackets
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR") //gói thứ 3 bắt đầu vào load profile
                                    {
                                        for (byte i = 0; i < modem._shortName.loadprofile_shortname.Count; i++)
                                        {
                                            modem.getLoadprofile = 0x0001;
                                            modem.getHistorical = 0x0001;
                                            byte[] cmdBytes = getCmdLoadHis(ref modem, new byte[] { 0x01 }, "6270", "LOADPROFILE.DATA");

                                            // In ra hex string
                                            string hex = BitConverter.ToString(cmdBytes).Replace("-", " ");
                                            // Gửi ngay gói này đi
                                            await stream.WriteAsync(cmdBytes, 0, cmdBytes.Length);
                                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(cmdBytes).Replace("-", "")}", Color.Red, Color.Red);
                                        }
                                    }
                                    break;

                                case 9: // maxPackets
                                    if (clsData.BDPT_METERTYPE == "LANDISGYR") //gói thứ 3 bắt đầu vào load profile
                                    {
                                        modem.sequence_number.sss = 8;
                                        modem.sequence_number.rrr = 4;
                                        for (byte i = 0; i < modem._shortName.loadprofile_shortname.Count; i++)
                                        {
                                            byte[] cmdBytes = getCmdFollowup(ref modem);
                                            if (modem.listcmdsend == null)
                                                modem.listcmdsend = new List<command>();
                                            modem.listcmdsend.Add(new command(COMMANDS.LOADPROFILECONFIG, cmdBytes, false, null, true));

                                            // In ra hex string
                                            string hex = BitConverter.ToString(cmdBytes).Replace("-", " ");
                                            // Gửi ngay gói này đi
                                            await stream.WriteAsync(cmdBytes, 0, cmdBytes.Length);
                                            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(cmdBytes).Replace("-", "")}", Color.Red, Color.Red);
                                        }
                                    }
                                    break;

                                default:
                                    // kết thúc hoặc các lệnh khác
                                    break;
                            }
                        }
                        break;
                    case EVENT.READ_ALL:
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.isReading = false;
                            dcu.status = STATUS.Online.ToString(); // Mặc định Online nếu vẫn kết nối
                            if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                            break;
                        }
                        if (dcu.currentindex > dcu.diemDos.Count - 1)
                        {
                            dcu.isReading = false;
                            dcu.status = STATUS.Online.ToString();
                            if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;

                            if (dcu.failedDiemDos != null && dcu.failedDiemDos.Count > 0)
                            {
                                #region KHÁM PHÁ LẠI ĐIỂM ĐO CHƯA ĐỌC ĐƯỢC
                                // Nếu đây là lần đọc sau khi khám phá lại -> KHÔNG khám phá nữa
                                if (dcu.isreread && dcu.rediscoveredSuccessList != null)
                                {
                                    AppendLog(ref dcu, true, true,
                                        $"Có {dcu.rediscoveredSuccessList.Count} điểm đo đọc lại sau khám phá không thành công. Dừng tiến trình.",
                                        Color.Red, Color.Red);

                                    dcu.isRediscovery = false;
                                    dcu.Event = EVENT.STOP;
                                    dcu.failedDiemDos.Clear();
                                    AppendLog(ref dcu, true, true, "Tiến trình đọc đã kết thúc.", Color.Orange, Color.Orange);
                                    return 0;
                                }

                                AppendLog(ref dcu, true, true,
                                $"Có {dcu.failedDiemDos.Count} điểm đo chưa đọc được.",
                                Color.DarkOrange, Color.DarkOrange);

                                AppendLog(ref dcu, true, true,
                                    $"Bắt đầu tiến trình khám phá lại đường dẫn với các điểm đo đọc thất bại...",
                                    Color.Blue, Color.Blue);

                                // Xóa đường dẫn cũ
                                foreach (var dd in dcu.failedDiemDos)
                                {
                                    dd.SPIDER_PATH = "";
                                    dd.SPIDER_READ = "";
                                    dd.SPIDER_LEVEL = 0;
                                }

                                // Chỉ khám phá lại các điểm đo lỗi
                                dcu.failedlist = dcu.failedDiemDos.ToList();
                                dcu.failedDiemDos = new List<DIEMDO>();
                                dcu.diemDos = dcu.failedlist;
                                dcu.currentindex = 0;
                                dcu.isRediscovery = true;
                                dcu.stopDiscovery = false;

                                // Gọi tiến trình DISCOVERY
                                dcu.Event = EVENT.DISCOVERY;
                                await ProcessEvent(stream, amountReadTask, dcu);
                                return 0;
                                #endregion
                            }
                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                            dcu.failedDiemDos = new List<DIEMDO>();
                            dcu.Event = EVENT.STOP;
                            if (dcu?.mStation != null)
                            {
                                if (dcu.mStation.STATUS == STATUS.Online)
                                {
                                    dcu.mStation.COUNTER_CONNECTED_times++;

                                }
                                else
                                {
                                    dcu.mStation.COUNTER_DISCONNECTED++;
                                }
                                dcu.mStation.COUNTER_READCYCLE++;
                                int idx = clsGeneral.stationBindingList.IndexOf(dcu.mStation);
                                if (idx >= 0) clsGeneral.stationBindingList.ResetItem(idx);
                            }
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        diemDo = dcu.diemDos[dcu.currentindex]; // Sử dụng danh sách đã lọc
                        loaiBCS = diemDo.LOAI_BCS;
                        versionRF = diemDo.VERSION_RF ?? "";
                        meterTypeToUse = diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        if (diemDo.VERSION_RF == "DT01PRF_433_1200_3BYTE_V100" && dcu.previousIndex != dcu.currentindex)//chuyển tần số về 433
                        {
                            dataInstance = new clsData();
                            commandListbyte = dataInstance.init_cmd_send_fre_433();
                            foreach (var sendCmd in commandListbyte)
                            {
                                // Gửi lệnh
                                await stream.WriteAsync(sendCmd, 0, sendCmd.Length);
                                AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmd).Replace("-", "")}", Color.Red, Color.Red);

                                // Đọc phản hồi
                                recvBuffer = new byte[256];
                                amountRead = await stream.ReadAsync(recvBuffer, 0, recvBuffer.Length);

                                dcu.receivedData = recvBuffer.AsMemory(0, amountRead);
                                str = Encoding.Latin1.GetString(dcu.receivedData.Span);
                                hexString = BitConverter.ToString(dcu.receivedData.Span.ToArray()).Replace("-", "");
                                AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\t{hexString}", Color.Blue, Color.Blue);
                                await Task.Delay(500);
                            }
                        }
                        commandList = clsData.GetCommandListByLoaiBCS(true, true, false, loaiBCS, meterType, versionRF);
                        if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT03MRF_408_4800_8BYTE_V260")
                        {
                            cmdType = clsRFSpider.CMD_READ_MESH;
                            dcu.maxsubIndex = commandList.Count - 1;
                        }
                        else
                        {
                            if (dcu.subIndex == 0)
                                dcu.maxsubIndex = commandList.Count - 1;
                        }
                        if (dcu.subIndex >= commandList.Count)//nguyennvp 18/06/2025
                        {
                            dcu.subIndex = commandList.Count - 1;
                        }
                        cmdType = commandList[dcu.subIndex];
                        if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT01PRF_408_4800_4BYTE_V405" || versionRF == "DT03MRF_408_4800_8BYTE_V260") //các giao thức này luôn đọc mesh
                        {
                            path_read = GetProcessedSpiderRead_mesh(diemDo, dcu);
                            cmdType = clsRFSpider.CMD_READ_MESH;
                            byte sub_mesh_cmd = commandList[dcu.subIndex];
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_mesh(diemDo, path_read, cmdType, sub_mesh_cmd, []);
                        }
                        else
                        {
                            path_read = ProcessSpiderReadPath(diemDo.SPIDER_READ, diemDo.SERY_CTO, versionRF, dcu.masterID);
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_new(diemDo, path_read, cmdType);
                        }
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            if (string.IsNullOrEmpty(diemDo.SPIDER_READ))
                            {
                                diemDo.SPIDER_READ = $"{dcu.masterID}:{clsRFSpider.meter_info.rssi_meter}:0:1";
                            }
                            AppendLog(ref dcu, false, true, $"Đang đọc {dcu.cmds.serial} với đường dẫn {diemDo.SPIDER_READ}... Vui lòng đợi...", Color.RosyBrown, Color.RosyBrown);
                            AppendLog(ref dcu, true, false, String.Format("\t*** Đọc công tơ {0} ***", dcu.cmds.serial.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                            diemDo.TOTAL_READ++;
                        }
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);
                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        await Task.Delay(100);
                        break;
                    case EVENT.READ_BILLING:
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        if (dcu.currentindex > dcu.diemDos.Count - 1)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        diemDo = dcu.diemDos[dcu.currentindex]; // Sử dụng danh sách đã lọc                                               
                        versionRF = diemDo.VERSION_RF ?? "";
                        meterTypeToUse = diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, true, String.Format("\t*** Đọc công tơ {0} ***", diemDo.SERY_CTO.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        path_read = GetProcessedSpiderRead_mesh(diemDo, dcu);
                        cmdType = clsRFSpider.CMD_READ_MESH;
                        // Kiểm tra công tơ DT01P hoặc DT01P80 chỉ có 1 biểu giá
                        if (!already_Notified && clsRFSpider.SingleBillingMeterTypes.Contains(meterType))
                        {
                            already_Notified = false;
                            AppendLog(ref dcu, true, true, $"Đọc công tơ chủng loại {meterTypeToUse} không thành công!", Color.Red, Color.Red);
                            dcu.currentindex++;
                            await ProcessEvent(stream, amountReadTask, dcu);
                            return -1;
                        }
                        int result = await HandleBillingReadAsync(dcu, diemDo, path_read, cmdType);
                        if (result == 0) return 0;
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, true, String.Format("\t*** Đọc công tơ {0} ***", dcu.cmds.serial.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);

                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        await Task.Delay(100);
                        break;
                    case EVENT.READ_EVENT:
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        if (dcu.currentindex > dcu.diemDos.Count - 1)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        diemDo = dcu.diemDos[dcu.currentindex]; // Sử dụng danh sách đã lọc                                         
                        versionRF = diemDo.VERSION_RF ?? "";
                        meterTypeToUse = diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, true, String.Format("\t*** Đọc công tơ {0} ***", diemDo.SERY_CTO.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        path_read = ProcessSpiderReadPath(diemDo.SPIDER_READ, diemDo.SERY_CTO, versionRF, dcu.masterID);
                        cmdType = clsRFSpider.CMD_RF_READ;
                        if (!already_Notified && clsRFSpider.SingleEventMeterTypes.Contains(meterType))
                        {
                            already_Notified = false;
                            AppendLog(ref dcu, true, true, $"Đọc công tơ chủng loại {meterTypeToUse} không thành công!", Color.Red, Color.Red);
                            dcu.currentindex++;
                            await ProcessEvent(stream, amountReadTask, dcu);
                            return -1;
                        }
                        if (dcu.indexEventList == null || dcu.indexEventList.Count == 0)
                        {
                            switch (versionRF)
                            {
                                case "DT01MRF_408_4800_8BYTE_V234_AES":
                                    dcu.indexEventList = Enumerable.Range(0, 18).Select(x => (byte)x).ToList();
                                    break;
                                default:
                                    dcu.indexEventList = Enumerable.Range(0, 30).Select(x => (byte)x).ToList();
                                    break;
                            }
                            dcu.currentEventIdx = 0;
                        }
                        byte indexEvent = dcu.indexEventList[dcu.currentEventIdx];
                        dcu.cmds = await dcu.GenerateCommandFromDiemDo_new_tariff(diemDo, path_read, cmdType, new byte[] { indexEvent });
                        dcu.cmds.eventindex = indexEvent;
                        clsRFSpider.index_tariff = dcu.cmds.eventindex;//nguyennvp thêm để cập nhật                        
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, false, String.Format("\t*** Đọc công tơ {0} ***", dcu.cmds.serial.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);

                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        await Task.Delay(100);
                        break;
                    case EVENT.READ_TARIFF:
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        if (dcu.currentindex > dcu.diemDos.Count - 1)
                        {
                            dcu.status = STATUS.Online.ToString();
                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString(); if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                            clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        diemDo = dcu.diemDos[dcu.currentindex]; // Sử dụng danh sách đã lọc                                               
                        versionRF = diemDo.VERSION_RF ?? "";
                        meterTypeToUse = diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, true, String.Format("\t*** Đọc công tơ {0} ***", diemDo.SERY_CTO.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        // Kiểm tra công tơ DT01P hoặc DT01P80 chỉ có 1 biểu giá
                        if (!already_Notified && clsRFSpider.SingleTariffMeterTypes.Contains(meterType))
                        {
                            already_Notified = false;
                            AppendLog(ref dcu, true, true, $"Đọc công tơ chủng loại {meterTypeToUse} không thành công!", Color.Red, Color.Red);
                            dcu.currentindex++;
                            await ProcessEvent(stream, amountReadTask, dcu);
                            return -1;
                        }
                        if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT01PRF_408_4800_4BYTE_V405" || versionRF == "DT03MRF_408_4800_8BYTE_V260") //các giao thức này luôn đọc mesh
                        {
                            dcu.maxsubIndex = 2;
                            path_read = GetProcessedSpiderRead_mesh(diemDo, dcu);
                            byte sub_mesh_cmd = GetSubCmdForMesh_tariff(dcu.subIndex);
                            if (dcu.lastSubMeshCmd != sub_mesh_cmd)
                            {
                                dcu.indexTariffList = null;
                                dcu.lastSubMeshCmd = sub_mesh_cmd;
                            }
                            if (dcu.indexTariffList == null || dcu.indexTariffList.Count == 0)
                            {
                                if (sub_mesh_cmd == clsRFSpider.SUBCMD_MESH_TARIFF_REG_VALUE)//đọc biểu giá 
                                {
                                    dcu.indexTariffList = Enumerable.Range(0, 16).Select(x => (byte)x).ToList();
                                }
                                else
                                { //đọc thanh ghi max demand
                                    dcu.indexTariffList = Enumerable.Range(0, 8).Select(x => (byte)x).ToList();
                                }
                                dcu.currentTariffIdx = 0;
                            }

                            byte indexTariff = dcu.indexTariffList[dcu.currentTariffIdx];
                            byte[] subCmdWithIndex = new byte[] { sub_mesh_cmd, indexTariff };
                            cmdType = clsRFSpider.CMD_READ_MESH;
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_mesh(diemDo, path_read, cmdType, sub_mesh_cmd, subCmdWithIndex);
                            dcu.cmds.tariffindex = indexTariff;
                            clsRFSpider.index_tariff = dcu.cmds.tariffindex;//nguyennvp thêm để cập nhật
                        }
                        else //các loại công tơ khác đọc biểu giá, đọc theo F0
                        {
                            path_read = ProcessSpiderReadPath(diemDo.SPIDER_READ, diemDo.SERY_CTO, versionRF, dcu.masterID);
                            cmdType = clsRFSpider.CMD_READ_TARIFF_INFO;
                            if (dcu.indexTariffList == null || dcu.indexTariffList.Count == 0)
                            {
                                // Tạo list từ 0x00 đến 0x05 (0, 1, 2, 3, 4, 5)
                                dcu.indexTariffList = Enumerable.Range(0, 6).Select(x => (byte)x).ToList();
                                dcu.currentTariffIdx = 0;
                            }
                            byte indexTariff = dcu.indexTariffList[dcu.currentTariffIdx];
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_new_tariff(diemDo, path_read, cmdType, new byte[] { indexTariff });
                            dcu.cmds.tariffindex = indexTariff;
                            clsRFSpider.index_tariff = dcu.cmds.tariffindex;//nguyennvp thêm để cập nhật
                        }
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, false, String.Format("\t*** Đọc công tơ {0} ***", dcu.cmds.serial.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);

                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        await Task.Delay(100);
                        break;
                    case EVENT.READ_TSVH: //Tri PH bổ sung 03.06.2025                   
                        diemDo = clsGeneral.diemdo_sel;
                        if (diemDo == null)
                        {
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                            break;
                        }
                        if (dcu.currentindex > 0) // Đọc 01 điểm đo duy nhất current index = 0;
                        {
                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        versionRF = diemDo.VERSION_RF ?? "";
                        meterTypeToUse = diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        loaiBCS = diemDo.LOAI_BCS;
                        commandList = clsData.GetCommandListByLoaiBCS(false, true, false, loaiBCS, meterType, versionRF);
                        if (dcu.subIndex == 0)
                        {
                            dcu.maxsubIndex = commandList.Count - 1;
                        }
                        dcu.status = STATUS.Reading.ToString();
                        cmdType = commandList[dcu.subIndex];
                        dcu.cmds = await dcu.GenerateCommandFromDiemDo_new(diemDo, "", cmdType);
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);
                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        dcu.subIndex++;
                        await Task.Delay(50);
                        break;
                    case EVENT.READ_ONE: // Tri PH bổ sung 04.06.2025
                        diemDo = clsGeneral.diemdo_sel;
                        if (diemDo == null)
                        {
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                            break;
                        }
                        if (dcu.currentindex > 0) // Đọc 01 điểm đo duy nhất current index = 0;
                        {
                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        versionRF = diemDo.VERSION_RF ?? "";
                        meterTypeToUse = diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        if (diemDo.VERSION_RF == "DT01PRF_433_1200_3BYTE_V100" && dcu.previousIndex != dcu.currentindex)//chuyển tần số về 433
                        {
                            dataInstance = new clsData();
                            commandListbyte = dataInstance.init_cmd_send_fre_433();
                            foreach (var sendCmd in commandListbyte)
                            {
                                // Gửi lệnh
                                await stream.WriteAsync(sendCmd, 0, sendCmd.Length);
                                AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmd).Replace("-", "")}", Color.Red, Color.Red);

                                // Đọc phản hồi
                                recvBuffer = new byte[256];
                                amountRead = await stream.ReadAsync(recvBuffer, 0, recvBuffer.Length);

                                dcu.receivedData = recvBuffer.AsMemory(0, amountRead);
                                str = Encoding.Latin1.GetString(dcu.receivedData.Span);
                                hexString = BitConverter.ToString(dcu.receivedData.Span.ToArray()).Replace("-", "");
                                AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\t{hexString}", Color.Blue, Color.Blue);

                                // Nếu cần delay giữa các lần gửi
                                await Task.Delay(500);
                            }
                        }
                        commandList = clsData.GetCommandListByLoaiBCS(true, true, false, "KT,KN,VC,VN", meterType, versionRF);
                        commandList = commandList.Take(4).ToList();
                        if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT03MRF_408_4800_8BYTE_V260")
                        {
                            cmdType = clsRFSpider.CMD_READ_MESH;
                            dcu.maxsubIndex = commandList.Count - 1;
                        }
                        else
                        {
                            if (dcu.subIndex == 0)
                                dcu.maxsubIndex = commandList.Count - 1;
                        }
                        if (dcu.subIndex >= commandList.Count)//nguyennvp 18/06/2025
                        {
                            dcu.subIndex = commandList.Count - 1;
                        }
                        cmdType = commandList[dcu.subIndex];

                        if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT01PRF_408_4800_4BYTE_V405" || versionRF == "DT03MRF_408_4800_8BYTE_V260") //các giao thức này luôn đọc mesh
                        {
                            path_read = GetProcessedSpiderRead_mesh(diemDo, dcu);
                            cmdType = clsRFSpider.CMD_READ_MESH;
                            byte sub_mesh_cmd = commandList[dcu.subIndex];
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_mesh(diemDo, path_read, cmdType, sub_mesh_cmd, []);
                        }
                        else
                        {
                            path_read = ProcessSpiderReadPath(diemDo.SPIDER_READ, diemDo.SERY_CTO, versionRF, dcu.masterID);
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_new(diemDo, path_read, cmdType);
                        }
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, false, String.Format("\t*** Đọc công tơ {0} ***", dcu.cmds.serial.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);

                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        await Task.Delay(100);
                        break;
                    case EVENT.DISCOVERY: // Trí PH bổ sung 12.06.2025
                        if (dcu.discover_condition > dcu.discover_condition_max) // kết thúc
                        {
                            if (dcu.isreread) //đọc lại các điểm đo khám phá lại thành công
                            {
                                var listDiscovered = dcu.rediscoveredSuccessList;
                                AppendLog(ref dcu, true, true,
                                    $"Khám phá lại hoàn tất. Có {listDiscovered.Count} điểm đo thành công, bắt đầu đọc lại...",
                                    Color.Blue, Color.Blue);

                                // Gán danh sách điểm đo cần đọc lại
                                dcu.diemDos = listDiscovered;
                                dcu.currentindex = 0;
                                dcu.subIndex = 0;
                                dcu.isRediscovery = false;
                                dcu.stopDiscovery = false;
                                dcu.Event = EVENT.READ_ALL;

                                await ProcessEvent(stream, amountReadTask, dcu);
                                return 0;
                            }
                            else
                            {
                                dcu.status = STATUS.Online.ToString();
                                AppendLog(ref dcu, true, true, "Kết thúc tiến trình Khám phá đường dẫn...", Color.Blue, Color.OrangeRed);
                                dcu.Event = EVENT.STOP;
                                dcu.stopDiscovery = true;
                                dcu.isReading = false;
                                //reset lại các biến;
                                dcu.reset_all();
                                //await dcu.syncData(); //Đồng bộ lại dữ liệu
                            }
                            break;
                        }
                        if (dcu.diemDos == null || dcu.diemDos.Count == 0)
                        {
                            dcu.discover_condition++;// tăng loại discovery lên chủng loại khác
                                                     //reset các giá trị của dcu.diemDos
                            dcu.discovery_level = 0;
                            dcu.discovery_meter_mesh_level = 0;
                            dcu.previousIndex = -1;
                            dcu.currentindex = 0;
                            dcu.subIndex = 0;
                            dcu.discovery_path_level = 0;
                            dcu.success_disco_path = "";
                            dcu.cts.SetCanceled();
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        diemDo = dcu.diemDos[dcu.currentindex]; // Đọc theo thứ tự toàn bộ danh sách trạm                    
                        loaiBCS = diemDo.LOAI_BCS;
                        versionRF = diemDo.VERSION_RF ?? "";
                        meterTypeToUse = diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        commandList = clsData.GetCommandListByLoaiBCS(false, false, true, loaiBCS, meterType, versionRF);
                        dcu.maxsubIndex = commandList.Count - 1;

                        cmdType = commandList[dcu.subIndex];
                        //....TẠO ĐƯỜNG DẪN KHÁM PHÁ......                   
                        try
                        {
                            dcu.discovery_lever_max = dcu.dt.Max(x => x.SPIDER_LEVEL);
                        }
                        catch { }
                        for (int i = dcu.discovery_meter_mesh_level; i <= dcu.discovery_meter_mesh_level_max;)
                        {
                            if (dcu.get_paths_discovery(clsGeneral.spider_paths, ref dcu.arr_path_quyen, dcu.discovery_level, 1, dcu.success_disco_path, dcu.discovery_meter_mesh_level) == false)
                            {
                                if (dcu.discovery_level == 0)
                                {
                                    AppendLog(ref dcu, true, true, "Không lấy được path quyển level 0...", Color.Red, Color.Black);
                                    dcu.Event = EVENT.STOP;
                                    dcu.stopDiscovery = true;
                                    dcu.isReading = false;
                                    //reset lại các biến;
                                    dcu.reset_all();
                                    return -1;
                                }
                                else
                                {
                                    dcu.discovery_meter_mesh_level++;
                                    continue;
                                }

                            }
                            if (dcu.arr_path_quyen.Length <= 0)
                            {
                                dcu.discovery_meter_mesh_level++;
                                continue;
                            }
                            else break;
                        }

                        if (dcu.arr_path_quyen.Length <= 0)
                        {
                            AppendLog(ref dcu, true, true, "Không lấy được path quyển...", Color.Red, Color.Black);
                            break;
                        }
                        dcu.previous_disco_path = dcu.current_disco_path;
                        dcu.current_disco_path = clsGeneral.get_path(diemDo, dcu, dcu.arr_path_quyen[dcu.discovery_path_level]);
                        if (string.IsNullOrEmpty(dcu.current_disco_path))
                        {
                            AppendLog(ref dcu, true, true, "Không tồn tại đường dẫn nào...", Color.Red, Color.Black);
                            break;
                        }
                        path_read = dcu.current_disco_path.Split(':')[0];
                        string[] path_nodes;
                        path_nodes = path_read.Split(';');
                        //path_nodes = ["99212267", "16394914", "16388525", "17104610"];
                        if (path_nodes.Length <= 1 || (path_nodes.Length == 2 && path_nodes[path_nodes.Length - 1] == diemDo.SERY_CTO))
                        {
                            path_read = "";
                        }
                        //else if ((path_nodes.Length > 2 && path_nodes[path_nodes.Length - 1] == diemDo.SERY_CTO))
                        else if (path_nodes.Length > 2 && path_nodes[^1] == diemDo.SERY_CTO) // nguyennvp 03-07-2025. Cập nhật lại đường dẫn mới
                        {
                            string[] new_array = new string[path_nodes.Length - 1];
                            Array.Copy(path_nodes, new_array, path_nodes.Length - 1);

                            path_nodes = new_array;
                            path_read = string.Join(";", path_nodes); // nguyennvp 03-07-2025. Cập nhật lại đường dẫn mới
                        }
                        //nguyennvp
                        //path_read = "99212267;16394914;16388525";
                        dcu.success_disco_path = ""; // set lại

                        if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT03MRF_408_4800_8BYTE_V260")
                        {
                            byte sub_mesh_cmd = GetSubCmdForMesh(dcu.subIndex);
                            byte[] subCmdWithIndex = new byte[] { sub_mesh_cmd, 0x00 };
                            if (string.IsNullOrEmpty(path_read))
                            {
                                path_read = dcu.masterID.ToString();
                            }
                            cmdType = clsRFSpider.CMD_READ_MESH;
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_mesh(diemDo, path_read, cmdType, sub_mesh_cmd, subCmdWithIndex);
                        }
                        else
                        {
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_new(diemDo, path_read, cmdType);
                        }
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        if ((dcu.previousIndex != dcu.currentindex) || (dcu.previous_disco_path != dcu.current_disco_path))
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, true, String.Format("Đọc công tơ {0} với đường dẫn <{1}>", dcu.cmds.serial, dcu.current_disco_path), Color.Black, Color.Purple);
                        }
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);
                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        //dcu.subIndex++;
                        await Task.Delay(50);
                        break;
                    case EVENT.MANUAL:
                        if (dcu.subIndex > dcu.maxsubIndex)
                        {
                            dcu.isReading = false;
                            dcu.status = STATUS.Online.ToString(); // Mặc định Online nếu vẫn kết nối
                            if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                                clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                            dcu.Event = EVENT.STOP;
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        string meterTypeFromXml;
                        versionRF = dcu.GetVersionRFBySerial(Convert.ToUInt32(SerialID), out meterTypeFromXml);
                        meterTypeToUse = !string.IsNullOrEmpty(meterTypeFromXml) ? meterTypeFromXml : diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        if (versionRF == "DT01PRF_433_1200_3BYTE_V100")//chuyển tần số về 433
                        {
                            dataInstance = new clsData();
                            commandListbyte = dataInstance.init_cmd_send_fre_433();
                            foreach (var sendCmd in commandListbyte)
                            {
                                // Gửi lệnh
                                await stream.WriteAsync(sendCmd, 0, sendCmd.Length);
                                AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmd).Replace("-", "")}", Color.Red, Color.Red);

                                // Đọc phản hồi
                                recvBuffer = new byte[256];
                                amountRead = await stream.ReadAsync(recvBuffer, 0, recvBuffer.Length);

                                dcu.receivedData = recvBuffer.AsMemory(0, amountRead);
                                str = Encoding.Latin1.GetString(dcu.receivedData.Span);
                                hexString = BitConverter.ToString(dcu.receivedData.Span.ToArray()).Replace("-", "");
                                AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\t{hexString}", Color.Blue, Color.Blue);

                                // Nếu cần delay giữa các lần gửi
                                await Task.Delay(500);
                            }
                        }
                        string loai_bcs = "KT";
                        commandList = clsData.GetCommandListByLoaiBCS(true, true, false, loai_bcs, meterType, versionRF);
                        if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT03MRF_408_4800_8BYTE_V260")
                        {
                            cmdType = clsRFSpider.CMD_READ_MESH;
                            dcu.maxsubIndex = commandList.Count - 1;
                        }
                        else
                        {
                            if (dcu.subIndex == 0)
                            {
                                dcu.maxsubIndex = commandList.Count - 1;
                            }
                        }
                        if (dcu.subIndex >= commandList.Count)//nguyennvp 18/06/2025
                        {
                            dcu.subIndex = commandList.Count - 1;
                        }
                        cmdType = commandList[dcu.subIndex];

                        if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT01PRF_408_4800_4BYTE_V405" || versionRF == "DT03MRF_408_4800_8BYTE_V260") //các giao thức này luôn đọc mesh
                        {
                            //path_read = GetProcessedSpiderRead_mesh(diemDo, dcu);
                            path_read = pathread;
                            cmdType = clsRFSpider.CMD_READ_MESH;
                            byte sub_mesh_cmd = commandList[dcu.subIndex];
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo_mesh(diemDo, path_read, cmdType, sub_mesh_cmd, []);
                        }
                        else
                        {
                            if (!string.IsNullOrEmpty(pathread))
                            {
                                string[] nodes = pathread.Split(';');
                                if (nodes.Length == 0)
                                {
                                    // Trường hợp chỉ có 0 node
                                    if (versionRF == "DT01MRF_408_4800_8BYTE_V260" || versionRF == "DT03MRF_408_4800_8BYTE_V260")
                                        path_read = dcu.masterID.ToString();
                                    else
                                        path_read = "";
                                }
                                else if (nodes.Length >= 1)
                                {
                                    path_read = dcu.masterID.ToString() + ";" + pathread;
                                }
                                else
                                {
                                    // Mặc định giữ nguyên
                                    path_read = pathread;
                                }
                            }
                            else { path_read = ""; }
                            dcu.cmds = await dcu.GenerateCommandFromDiemDo(path_read, versionRF, cmdType, SerialID, meterTypeToUse);
                        }
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        if (dcu.subIndex == 0 && dcu.retry == 0)
                        {
                            AppendLog(ref dcu, true, false, String.Format("\t*** Đọc công tơ {0} ***", dcu.cmds.serial.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);

                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        await Task.Delay(100);
                        break;
                    case EVENT.READ_ROUTER_3P_CONFIG:
                        diemDo = clsGeneral.diemdo_sel;
                        if (diemDo == null)
                        {
                            AppendLog(ref dcu, true, true, "Không có điểm đo nào để đọc!", Color.Black, Color.Red);
                            dcu.Event = EVENT.STOP;
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                            break;
                        }
                        if (dcu.currentindex > 0) // Đọc 01 điểm đo duy nhất current index = 0;
                        {
                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                            dcu.Event = EVENT.STOP;
                            dcu.isReading = false;
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);
                            break;
                        }
                        dcu.isReading = true;
                        dcu.status = STATUS.Reading.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Reading;
                        versionRF = diemDo.VERSION_RF ?? "";
                        meterTypeToUse = diemDo.METER_TYPE;
                        meterType = (clsRFSpider.METER_TYPE)Enum.Parse(typeof(clsRFSpider.METER_TYPE), meterTypeToUse);
                        cmdType = clsRFSpider.CMD_READ_MESH;
                        dcu.maxsubIndex = 0;
                        cmdType = 0x4D;
                        path_read = GetProcessedSpiderRead_mesh(diemDo, dcu);
                        cmdType = clsRFSpider.CMD_READ_MESH;
                        byte sub_mesh_cmd_1 = 0x4D;
                        dcu.cmds = await dcu.GenerateCommandFromDiemDo_mesh(diemDo, path_read, cmdType, sub_mesh_cmd_1, []);
                        await stream.WriteAsync(dcu.cmds.cmdSend, 0, dcu.cmds.cmdSend.Length);
                        hexSend = BitConverter.ToString(dcu.cmds.cmdSend).Replace("-", "");
                        if (dcu.previousIndex != dcu.currentindex)
                        {
                            dcu.previousIndex = dcu.currentindex;
                            AppendLog(ref dcu, true, false, String.Format("\t*** Đọc công tơ {0} ***", dcu.cmds.serial.ToString()), Color.DarkMagenta, Color.DarkMagenta);
                        }
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{hexSend}", Color.Red, Color.Red);

                        LogRawBytes(dcu.cmds.serial.ToString(), "SEND", dcu.cmds.cmdSend);
                        await Task.Delay(100);
                        break;
                    default:
                        break;
                }
                return 0;
            }
            catch (Exception ex)
            {
                AppendLog(ref dcu, true, false, String.Format("Loi ProcessEvent: {0}", ex.Message), Color.Red, Color.Black);
                return -1;
            }
        }
        private Task<string> ReceiveAndProcessData(clientmanagerV4 dcu, byte[] buffer)
        {
            dcu.receivedData = buffer.AsMemory(0, amountRead);
            string hexString = BitConverter.ToString(dcu.receivedData.Span.ToArray()).Replace("-", "");
            dcu.Received_ByteArray = dcu.receivedData.ToArray();
            string asciiCmd = Encoding.ASCII.GetString(dcu.Received_ByteArray);

            // Cảnh báo sự kiện DCU
            string datareceive = clsConvert.ToStringLsb(dcu.Received_ByteArray);
            string canhbaomatdien_dcu1P = clsConvert.ToStringAscii(datareceive);
            if (canhbaomatdien_dcu1P.Contains("powerdown"))
                AppendLog(ref dcu, true, true, "Cảnh báo sự kiện: DCU mất điện!", Color.Red, Color.Red);
            else if (canhbaomatdien_dcu1P.Contains("powerup"))
                AppendLog(ref dcu, true, true, "DCU đã được khởi động!", Color.Green, Color.Green);

            AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT}\t<===\t{hexString}", Color.Blue, Color.Blue);
            //AppendLog(ref dcu, true, false, $"\n{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\t{asciiCmd}", Color.Blue, Color.Blue);
            LogRawBytes(dcu.cmds.serial.ToString(), "RECV", dcu.receivedData.ToArray());
            return Task.FromResult(asciiCmd);
        }
        #endregion

        #region TÁCH NHỎ HÀM PROCESSDATALOOP
        //private async Task HandleDiscoveryAsync(clientmanagerV4 dcu, DIEMDO diemDo, List<DIEMDO> diemDoList, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        //{
        //    string logMsg = "";
        //    byte[] recvBuffer = new byte[256];
        //    if (dcu.dt != null && dcu.currentindex >= 0 && dcu.currentindex < diemDoList.Count)
        //    {
        //        diemDo = diemDoList[dcu.currentindex];
        //        if (clsData.listcmdChiso.Contains(dcu.cmds.cmd_rf))
        //        {
        //            await Update_Chiso(diemDo, clsRFSpider.meter_info);
        //        }
        //    }
        //    //hiển thị log
        //    logMsg = BuildCommandLog(dcu.cmds.serial.ToString(), dcu.cmds.cmd_rf, cs_moi, cs_string, rssi, dcu.cmds.protocolRF, dcu);
        //    clsLogFile.AppendRichTextBox(ref dcu.rtblog, logMsg, Color.Black);
        //    //kiểm tra chỉ số
        //    if (cs_moi != -1) // đọc thành công điểm đo
        //    {
        //        dcu.subIndex++; // tăng cmd đọc
        //        dcu.retry = 0; // set lại biến retry cho lượt đọc mới 
        //        if (dcu.subIndex > dcu.maxsubIndex)
        //        {
        //            //dcu.success_disco_path = dcu.current_disco_path; // gán giá trị đường dẫn đọc thành công
        //            // sắp xếp lại đường dẫn
        //            string spider_path_in_grid = diemDo.SPIDER_PATH;
        //            if (diemDo.METER_TYPE == clsHU.METER_TYPE.DT01P80RF.ToString() && diemDo.MESH == true) clsRFSpider.meter_info.rssidBm = clsHU.calcRSSIdBm(clsRFSpider.meter_info.rssi_meter);

        //            bool mesh_status = false;
        //            if (dcu.discover_condition <= 1) // loại ROUTER, MESH 
        //                mesh_status = true;
        //            switch (mesh_status)
        //            {
        //                case true:
        //                    if (clsGeneral.check_exists_path(ref spider_path_in_grid, dcu.current_disco_path, mesh_status, clsRFSpider.meter_info.rssidBm, clsRFSpider.meter_info.level, dcu.pa_flag) == true)
        //                    {
        //                        diemDo.SPIDER_PATH = spider_path_in_grid;
        //                        diemDo.SPIDER_LEVEL = clsRFSpider.meter_info.level;
        //                        //thuc hien sort duong dan theo rssi
        //                        diemDo.SPIDER_PATH = clsGeneral.GetSort_Path(clsGeneral.cut_path(diemDo.SPIDER_PATH, clsGeneral.spiderpath_node_max));
        //                        string[] paths = diemDo.SPIDER_PATH.Split(new char[] { '/' });
        //                        if (paths.Length > 0)
        //                            diemDo.SPIDER_READ = dcu.success_disco_path = paths[0];
        //                        else
        //                            diemDo.SPIDER_READ = dcu.success_disco_path = diemDo.SPIDER_PATH;
        //                    }
        //                    break;
        //                case false:
        //                    if (clsGeneral.check_exists_path(ref spider_path_in_grid, dcu.current_disco_path, mesh_status, clsRFSpider.meter_info.rssidBm, clsRFSpider.meter_info.level, dcu.pa_flag) == true)
        //                    {
        //                        diemDo.SPIDER_PATH = spider_path_in_grid;
        //                        diemDo.SPIDER_LEVEL = clsRFSpider.meter_info.level;
        //                        //thuc hien sort duong dan theo rssi
        //                        diemDo.SPIDER_PATH = clsGeneral.GetSort_rssi(clsGeneral.cut_path(diemDo.SPIDER_PATH, clsGeneral.spiderpath_node_max));
        //                        string[] paths = diemDo.SPIDER_PATH.Split(new char[] { '/' });
        //                        if (paths.Length > 0)
        //                            diemDo.SPIDER_READ = paths[0];
        //                        else
        //                            diemDo.SPIDER_READ = diemDo.SPIDER_PATH;
        //                        string[] path_temps = diemDo.SPIDER_READ.Split(new char[] { ':' });
        //                        string path_temp = path_temps[0]; // bỏ phần từ sau :
        //                        string[] path_temp1 = path_temp.Split(new char[] { ';' }); // lấy các note
        //                        if ((path_temp1.Length > 1) && (path_temp1[path_temp1.Length - 1] == diemDo.SERY_CTO))
        //                        {
        //                            if (path_temp1.Length > 2)
        //                                dcu.success_disco_path = string.Join(" ", new ArraySegment<string>(path_temp1, 0, path_temp1.Length - 2));
        //                            else
        //                                dcu.success_disco_path = path_temp1[0];
        //                        }
        //                    }
        //                    break;
        //            }

        //            //
        //            AppendLog(ref dcu, true, true, String.Format("Discovery thành công điểm đo chủng loại <{0}>, serial <{1}>, path = {2}; RSSI = {3}; kWhImport = {4}", diemDo.METER_TYPE, diemDo.SERY_CTO, dcu.success_disco_path, clsRFSpider.meter_info.rssidBm.ToString(), clsRFSpider.meter_info.kWhImport.ToString()), Color.Green, Color.Green);

        //            // Lưu danh sách điểm đo khám phá lại thành công
        //            if (dcu.isRediscovery == true)
        //            {
        //                if (!dcu.rediscoveredSuccessList.Contains(diemDo))
        //                    dcu.rediscoveredSuccessList.Add(diemDo);
        //            }

        //            dcu.successdisco_diemdo++;
        //            Save_Json_Result(dcu, diemDo, clsRFSpider.meter_info, true);
        //            dcu.KetQuaChiSoMoi.Clear();
        //            dcu.KetQuaRSSI.Clear();
        //            dcu.subIndex = 0;
        //            dcu.discovery_path_level = 0;
        //            dcu.currentindex++; // chuyển điểm đo
        //            clsRFSpider.meter_info = new clsRFSpider.MeterInfor(); // khởi tạo lại bộ chỉ số công tơ
        //            clsRFSpider.meter_info.init();
        //            if (dcu.currentindex > diemDoList.Count - 1) // nếu là điểm đo cuối thì tăng level discovery
        //            {
        //                dcu.discovery_level++;
        //                try
        //                {
        //                    dcu.discovery_lever_max = dcu.dt.Max(x => x.SPIDER_LEVEL); // chưa ổn, xem lại lấy lại từ lưới
        //                }
        //                catch { }
        //                dcu.currentindex = 0; // set lại current index để chạy 
        //                dcu.previousIndex = -1;
        //                if (dcu.discovery_level > dcu.discovery_lever_max) // nếu là level cuối thì chuyển mesh meter lever tiếp theo
        //                {
        //                    dcu.discovery_meter_mesh_level++;
        //                    //reset lại các giá trị
        //                    dcu.discovery_level = 0;
        //                    if (dcu.discovery_meter_mesh_level > dcu.discovery_meter_mesh_level_max) // nếu là mesh lever cuối thì tăng condition
        //                    {
        //                        dcu.discover_condition++;
        //                        dcu.discovery_meter_mesh_level = 0;//reset
        //                    }
        //                }
        //                diemDoList = clsGeneral.GetListDiscovery(dcu); // lấy danh sách discovery để bỏ những điểm đã có đường dẫn
        //            }
        //        }
        //        await SendRefreshCommands(dcu, stream, diemDo);//chuyển tần số về 408
        //    }
        //    else if (cs_moi == -1)
        //    {
        //        dcu.retry++; // tăng retry để đọc lại cmd
        //        if (dcu.retry > dcu.maxretry) // hết lượt retry => chuyển pathrf tiếp theo
        //        {
        //            dcu.discovery_path_level++;
        //            dcu.retry = 0;
        //            await SendRefreshCommands(dcu, stream, diemDo);
        //            if (dcu.discovery_path_level > dcu.discovery_path_level_max) // nếu là path cuối thì chuyển điểm đo
        //            {
        //                dcu.KetQuaChiSoMoi.Clear();
        //                dcu.KetQuaRSSI.Clear();
        //                dcu.currentindex++;
        //                //reset lại các biến của 1 điểm đo                                           
        //                dcu.subIndex = 0;
        //                dcu.discovery_path_level = 0;
        //                clsRFSpider.meter_info = new clsRFSpider.MeterInfor(); // khởi tạo lại bộ chỉ số công tơ
        //                clsRFSpider.meter_info.init();
        //                if (dcu.currentindex > diemDoList.Count - 1) // nếu là điểm đo cuối thì tăng level discovery
        //                {
        //                    dcu.discovery_level++;
        //                    dcu.currentindex = 0; // set lại current index để chạy 
        //                    dcu.previousIndex = -1;
        //                    if (dcu.discovery_level > dcu.discovery_lever_max) // nếu là level cuối thì chuyển mesh meter lever tiếp theo
        //                    {
        //                        dcu.discovery_meter_mesh_level++;
        //                        //reset lại các giá trị
        //                        dcu.discovery_level = 0;
        //                        if (dcu.discovery_meter_mesh_level > dcu.discovery_meter_mesh_level_max) // nếu là mesh lever cuối thì tăng condition
        //                        {
        //                            dcu.discover_condition++;
        //                            dcu.discovery_meter_mesh_level = 0;//reset
        //                            dcu.discovery_level = 0;
        //                        }
        //                    }
        //                    diemDoList = clsGeneral.GetListDiscovery(dcu); // lấy danh sách discovery để bỏ những điểm đã có đường dẫn
        //                }
        //            }
        //        }
        //        else
        //        {
        //            AppendLog(ref dcu, true, false, String.Format("Retry lần {0}", dcu.retry), Color.DarkGray, Color.DarkGray);
        //        }
        //    }

        //    await ProcessEvent(stream, amountReadTask, dcu);
        //}
        private async Task HandleReadAllAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            if (dcu.dt != null && dcu.currentindex >= 0 && dcu.currentindex < dcu.diemDos.Count)
            {
                diemDo = dcu.diemDos[dcu.currentindex];
                if (clsData.listcmdChiso.Contains(dcu.cmds.cmd_rf))
                {
                    await Update_Chiso(diemDo, clsRFSpider.meter_info);

                    if (diemDo.CS_MOI == "FAIL" && dcu.retry == dcu.maxretry && !dcu.failedDiemDos.Any(dd => dd.SERY_CTO == diemDo.SERY_CTO))
                    {
                        dcu.failedDiemDos.Add(diemDo);
                    }
                }
            }
            // Kiểm tra chỉ số
            if (cs_moi != -1)
            {
                if (clsData.listcmdTSVH.Contains(dcu.cmds.cmd_rf) || (dcu.cmds.cmd_rf == clsRFSpider.CMD_READ_MESH && clsData.listSubCmdTSVH.Contains(dcu.cmds.sub_cmd)))
                {
                    diemDo.READ_TSVH = true;
                }
                AppendKetQuaDocChiSo(ref dcu, diemDo, cmdType, clsRFSpider.meter_info.rssi_meter, clsRFSpider.meter_info.kWhImport);
                clsGeneral.HasOverCurrentOrVoltage = clsGeneral.filteredlistdiemdo.Any(d => clsRFSpider.meter_info.CurrentA >= 1 || clsRFSpider.meter_info.VoltageA >= 220);
                if (clsGeneral.HasOverCurrentOrVoltage)
                {
                    clsGeneral.listOverCur.Add(new
                    {
                        MaDDO = diemDo.MA_DDO,
                        SeryCto = diemDo.SERY_CTO,
                        TenTram = dcu.mStation.TEN_TRAM,
                        DonVi = dcu.mStation.DVI_DLUC,
                        TrangThai = diemDo.CS_MOI != null && diemDo.CS_MOI != "" ? "Online" : "Offline",
                        GiaTriQuaDong = clsRFSpider.meter_info.CurrentA,
                        CapNhat = diemDo.NGAYGIO.ToString("dd/MM/yyyy HH:mm:ss")
                    });
                    clsGeneral.listOverVol.Add(new
                    {
                        MaDDO = diemDo.MA_DDO,
                        SeryCto = diemDo.SERY_CTO,
                        TenTram = dcu.mStation.TEN_TRAM,
                        DonVi = dcu.mStation.DVI_DLUC,
                        TrangThai = diemDo.CS_MOI != null && diemDo.CS_MOI != "" ? "Online" : "Offline",
                        GiaTriQuaAp = clsRFSpider.meter_info.VoltageA,
                        CapNhat = diemDo.NGAYGIO.ToString("dd/MM/yyyy HH:mm:ss")
                    });
                }

                if (dcu.subIndex >= dcu.maxsubIndex)
                {
                    AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thành công: Đường dẫn: {diemDo.SPIDER_READ}; RSSI Meter: {rssi} dBm; kWhImport: {clsRFSpider.meter_info.kWhImport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}", Color.Blue, Color.Blue);
                    diemDo.PASS_READ++;
                    dcu.hasLoggedSuccess = true;
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    dcu.subIndex = 0;
                    dcu.currentindex++;
                    dcu.hasLoggedSuccess = false;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                    await SendRefreshCommands(dcu, stream, diemDo);
                    dcu.status = STATUS.Online.ToString();
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                }
                else
                {
                    dcu.retry = 0;
                    dcu.subIndex++;
                }
            }
            else if (cs_moi == -1)
            {
                AppendKetQuaDocChiSo(ref dcu, diemDo, cmdType, rssi, cs_moi);
                var loaiBCS_Cmds = clsData.listcmdBCS;
                var loaiTSVH_cmds = clsData.listcmdTSVH;

                bool isBCS = loaiBCS_Cmds.Contains(dcu.cmds.cmd_rf) || dcu.cmds.protocolRF == "DT01MRF_408_4800_8BYTE_V260" || dcu.cmds.protocolRF == "DT03MRF_408_4800_8BYTE_V260";
                if (isBCS)
                {
                    dcu.retry++;
                    if (dcu.retry > dcu.maxretry)
                    {
                        //Lưu lại công tơ fail nếu chưa có trong danh sách
                        if (!dcu.failedDiemDos.Any(dd => dd.SERY_CTO == diemDo.SERY_CTO))
                        {
                            dcu.failedDiemDos.Add(diemDo);
                        }

                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex = 0;
                        dcu.currentindex++;
                        dcu.hasLoggedSuccess = false;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        await SendRefreshCommands(dcu, stream, diemDo);
                    }
                    else
                    {
                        AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                    }
                }
                else // TSVH
                {
                    dcu.retry++;
                    if (dcu.retry > dcu.maxretry)
                    {
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex++;
                        dcu.hasLoggedSuccess = false;
                        await SendRefreshCommands(dcu, stream, diemDo);
                    }
                    else
                    {
                        AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                    }
                }

                if (dcu.subIndex > dcu.maxsubIndex)
                {
                    if (clsRFSpider.meter_info.kWhImport > 0)
                    {
                        AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thành công: Đường dẫn: {diemDo.SPIDER_READ}; RSSI Meter: {rssi} dBm; kWhImport: {clsRFSpider.meter_info.kWhImport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}", Color.Blue, Color.Blue);
                        diemDo.PASS_READ++;
                        dcu.hasLoggedSuccess = true;
                    }
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.isReading = false;
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    dcu.subIndex = 0;
                    dcu.currentindex++;
                    dcu.hasLoggedSuccess = false;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                    await SendRefreshCommands(dcu, stream, diemDo);
                    dcu.status = STATUS.Online.ToString();
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                }
            }
            await ProcessEvent(stream, amountReadTask, dcu);
        }
        private async Task HandleReadBillingAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            bool isChotChiSo = dcu.cmds.sub_cmd == clsRFSpider.SUBCMD_READ_BILLING_DATA;

            if (dcu.dt != null && dcu.currentindex >= 0 && dcu.currentindex < dcu.diemDos.Count)
            {
                diemDo = dcu.diemDos[dcu.currentindex];
                if (clsData.listcmdChiso.Contains(dcu.cmds.cmd_rf))
                {
                    if (isChotChiSo)
                    {
                        // Cập nhật CS_CHOT
                        if (cs_moi >= 0 || !string.IsNullOrEmpty(cs_string))
                        {
                            string chiSoChot = !string.IsNullOrEmpty(cs_string) ? cs_string : cs_moi.ToString();
                            diemDo.CS_CHOT = chiSoChot;
                            diemDo.NGAY_CHOT = DateTime.Now;
                        }
                    }
                    else
                    {
                        // Cập nhật CS_MOI
                        if (cs_moi >= 0 || !string.IsNullOrEmpty(cs_string))
                        {
                            string chiSoMoi = !string.IsNullOrEmpty(cs_string) ? cs_string : cs_moi.ToString();
                            diemDo.CS_MOI = chiSoMoi;
                            diemDo.NGAYGIO = DateTime.Now;
                        }
                        else if (cs_moi == -1)
                        {
                            diemDo.CS_MOI = "Failed";
                            diemDo.NGAYGIO = DateTime.Now;
                        }
                    }
                }
            }
            // kiểm tra chỉ số ghi file
            if (cs_moi != -1)
            {
                AppendKetQuaDocChiSo(ref dcu, diemDo, cmdType, rssi, cs_moi);
                if (dcu.currentBillingIdx >= dcu.maxsubIndex - 1)
                {
                    if (!isReadingTimeOfBilling) { }
                    else
                    {
                        SaveJsonResultMulti(dcu, diemDo);
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.currentindex++;
                        dcu.currentBillingIdx = 0;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        dcu.status = STATUS.Online.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                    }
                }
                else
                {
                    dcu.retry = 0;
                    if (isReadingTimeOfBilling)
                    {
                        dcu.currentBillingIdx++;
                    }
                }
            }
            else if (cs_moi == -1)
            {
                dcu.retry++;
                if (dcu.retry >= dcu.maxretry)
                {
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    if (!isReadingTimeOfBilling)
                    {
                        dcu.flags["isReadingTimeOfBilling"] = true;
                    }
                    else
                    {
                        dcu.currentBillingIdx++;
                    }
                    dcu.currentBillingIdx++;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                }
                else
                {
                    if (!isReadingTimeOfBilling)
                    {
                        dcu.flags["isReadingTimeOfBilling"] = false;
                    }
                    else
                    {
                        dcu.flags["isReadingTimeOfBilling"] = true;
                    }
                    AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                }
                if (dcu.currentBillingIdx >= dcu.maxsubIndex - 1)
                {
                    if (!isReadingTimeOfBilling) { }
                    else
                    {
                        SaveJsonResultMulti(dcu, diemDo);
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.currentindex++;
                        dcu.currentBillingIdx = 0;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        dcu.status = STATUS.Online.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                    }
                }
            }
            await ProcessEvent(stream, amountReadTask, dcu);
        }
        private async Task HandleReadTariffAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            if (dcu.dt != null && dcu.currentindex >= 0 && dcu.currentindex < dcu.diemDos.Count)
            {
                diemDo = dcu.diemDos[dcu.currentindex];
            }
            // Kiểm tra chỉ số
            if (cs_moi != -1)
            {
                AppendKetQuaDocChiSo(ref dcu, diemDo, cmdType, rssi, cs_moi);
                dcu.currentTariffIdx++;
                if (dcu.currentTariffIdx >= dcu.indexTariffList.Count)
                {
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    dcu.currentMdIdx = 0;
                    dcu.subIndex = 0;
                    dcu.currentindex++;
                    dcu.currentTariffIdx = 0;
                    dcu.indexTariffList = [];
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                    dcu.status = STATUS.Online.ToString();
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                }
                else
                {
                    dcu.retry = 0;
                }
            }
            else if (cs_moi == -1)
            {
                dcu.retry++;
                if (dcu.retry > dcu.maxretry)
                {
                    //AppendKetQuaDocChiSo(ref dcu, diemDo, cmdType, rssi, cs_moi);
                    AppendLog(ref dcu, true, true, $"Đọc biểu giá serial {dcu.cmds.serial.ToString()} thất bại", Color.Red, Color.Red);
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    dcu.subIndex = 0;
                    dcu.currentTariffIdx++;
                    dcu.indexTariffList = [];
                    dcu.currentindex++;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                    dcu.status = STATUS.Online.ToString();
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                }
                else
                {
                    AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                }
                //if (dcu.currentTariffIdx > dcu.indexTariffList.Count - 1)
                //{
                //    dcu.currentTariffIdx = 0;
                //    dcu.indexTariffList = [];
                //    dcu.currentindex++;
                //}
            }

            await ProcessEvent(stream, amountReadTask, dcu);
        }
        private async Task HandleReadEventAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            if (dcu.dt != null && dcu.currentindex >= 0 && dcu.currentindex < dcu.diemDos.Count)
            {
                diemDo = dcu.diemDos[dcu.currentindex];
            }

            // Ghi file nếu đọc thành công
            if (cs_moi != -1)
            {
                AppendKetQuaDocChiSo(ref dcu, diemDo, cmdType, rssi, cs_moi);
                if (dcu.currentEventIdx >= dcu.indexEventList.Count - 1)
                {
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    dcu.currentEventIdx = 0;
                    dcu.indexEventList = [];
                    ; dcu.currentindex++;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                    dcu.status = STATUS.Online.ToString();
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                }
                else
                {
                    dcu.retry = 0;
                    dcu.currentEventIdx++;
                }
            }
            else if (cs_moi == -1)
            {
                dcu.retry++;
                if (dcu.retry > dcu.maxretry)
                {
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    dcu.indexEventList = [];
                    dcu.currentindex++;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init(); dcu.status = STATUS.Online.ToString();
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                }
                else
                {
                    AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                }
            }
            await ProcessEvent(stream, amountReadTask, dcu);
        }
        private async Task HandleReadTSVHAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            // Hiển thị log
            string logMsg = BuildCommandLog(dcu.cmds.serial.ToString(), dcu.cmds.cmd_rf, cs_moi, cs_string, rssi, dcu.cmds.protocolRF, dcu);
            clsLogFile.AppendRichTextBox(ref dcu.rtblog, logMsg, Color.Black);

            if (dcu.subIndex > dcu.maxsubIndex)
            {
                SaveJsonResultMulti(dcu, diemDo);
                dcu.KetQuaChiSoMoi.Clear();
                dcu.KetQuaRSSI.Clear();
                dcu.retry = 0;
                dcu.subIndex = 0;
                dcu.currentindex++;
                clsGeneral.meter_infor_save = clsRFSpider.meter_info;
                clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                clsRFSpider.meter_info.init();
                dcu.status = STATUS.Online.ToString();
                if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
            }

            await ProcessEvent(stream, amountReadTask, dcu);
        }
        private async Task HandleReadOneAsync(clientmanagerV4 dcu, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            if (clsGeneral.diemdo_sel != null)
            {
                int rowhandle = clsGeneral.find_rowhandle_by_serial(dcu, clsGeneral.diemdo_sel.SERY_CTO);
                DIEMDO diemDo = dcu.diemDos[rowhandle];
                // Hiển thị log
                string logMsg = BuildCommandLog(dcu.cmds.serial.ToString(), dcu.cmds.cmd_rf, cs_moi, cs_string, rssi, dcu.cmds.protocolRF, dcu);
                AppendLog(ref dcu, false, true, logMsg, Color.Blue, Color.Black);

                // Kiểm tra chỉ số
                if (cs_moi != -1)
                {
                    if (dcu.subIndex >= dcu.maxsubIndex)
                    {
                        SaveJsonResultMulti(dcu, diemDo);
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex = 0;
                        dcu.currentindex++;
                        clsGeneral.meter_infor_save = clsRFSpider.meter_info;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        await SendRefreshCommands(dcu, stream, diemDo);
                        dcu.status = STATUS.Online.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                    }
                    else
                    {
                        dcu.retry = 0;
                        dcu.subIndex++;
                    }
                }
                else if (cs_moi == -1)
                {
                    var loaiBCS_Cmds = clsData.listcmdBCS;
                    var loaiTSVH_cmds = clsData.listcmdTSVH;

                    bool isBCS = loaiBCS_Cmds.Contains(dcu.cmds.cmd_rf) || dcu.cmds.protocolRF == "DT01MRF_408_4800_8BYTE_V260" || dcu.cmds.protocolRF == "DT03MRF_408_4800_8BYTE_V260";
                    if (isBCS)
                    {
                        dcu.retry++;
                        if (dcu.retry > dcu.maxretry)
                        {
                            dcu.KetQuaChiSoMoi.Clear();
                            dcu.KetQuaRSSI.Clear();
                            dcu.retry = 0;
                            dcu.subIndex = 0;
                            dcu.currentindex++;
                            clsGeneral.meter_infor_save = clsRFSpider.meter_info;
                            clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                            clsRFSpider.meter_info.init();
                            await SendRefreshCommands(dcu, stream, diemDo);
                        }
                        else
                        {
                            AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                        }
                    }
                    else // TSVH
                    {
                        dcu.retry++;
                        if (dcu.retry > dcu.maxretry)
                        {
                            dcu.KetQuaChiSoMoi.Clear();
                            dcu.KetQuaRSSI.Clear();
                            dcu.retry = 0;
                            dcu.subIndex++;
                            clsGeneral.meter_infor_save = clsRFSpider.meter_info;
                            clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                            clsRFSpider.meter_info.init();
                            await SendRefreshCommands(dcu, stream, diemDo);
                        }
                        else
                        {
                            AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                        }
                    }

                    if (dcu.subIndex > dcu.maxsubIndex)
                    {
                        SaveJsonResultMulti(dcu, diemDo);
                        dcu.isReading = false;
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex = 0;
                        dcu.currentindex++;
                        clsGeneral.meter_infor_save = clsRFSpider.meter_info;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        await SendRefreshCommands(dcu, stream, diemDo);
                        dcu.status = STATUS.Online.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                    }
                }
                await ProcessEvent(stream, amountReadTask, dcu);
            }
            else { }
        }
        private async Task HandleReadConfigRouter3PAsync(clientmanagerV4 dcu, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            if (clsGeneral.diemdo_sel != null)
            {
                // Hiển thị log
                string logMsg = BuildCommandLog(dcu.cmds.serial.ToString(), dcu.cmds.cmd_rf, cs_moi, cs_string, rssi, dcu.cmds.protocolRF, dcu);
                AppendLog(ref dcu, false, true, logMsg, Color.Blue, Color.Black);

                // Kiểm tra chỉ số
                if (cs_moi != -1)
                {
                    if (dcu.subIndex >= dcu.maxsubIndex)
                    {
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex = 0;
                        dcu.currentindex++;
                        clsGeneral.meter_infor_save = clsRFSpider.meter_info;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        dcu.status = STATUS.Online.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                    }
                    else
                    {
                        dcu.retry = 0;
                        dcu.subIndex++;
                    }
                }
                else if (cs_moi == -1)
                {

                    dcu.retry++;
                    if (dcu.retry > dcu.maxretry)
                    {
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex = 0;
                        dcu.currentindex++;
                        clsGeneral.meter_infor_save = clsRFSpider.meter_info;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                    }
                    else
                    {
                        AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                    }

                    if (dcu.subIndex > dcu.maxsubIndex)
                    {
                        dcu.isReading = false;
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex = 0;
                        dcu.currentindex++;
                        clsGeneral.meter_infor_save = clsRFSpider.meter_info;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        dcu.status = STATUS.Online.ToString();
                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                    }
                }
                await ProcessEvent(stream, amountReadTask, dcu);
            }
            else { }
        }
        private async Task HandleManualAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            if (dcu.dt != null && dcu.currentindex >= 0 && dcu.currentindex < dcu.diemDos.Count)
            {
                diemDo = dcu.diemDos[dcu.currentindex];
                if (clsData.listcmdChiso.Contains(dcu.cmds.cmd_rf))
                {
                    await Update_Chiso(diemDo, clsRFSpider.meter_info);
                }
            }

            // Hiển thị log
            string logMsg = BuildCommandLog(dcu.cmds.serial.ToString(), dcu.cmds.cmd_rf, cs_moi, cs_string, rssi, dcu.cmds.protocolRF, dcu);
            AppendLog(ref dcu, false, true, logMsg, Color.Blue, Color.Black);

            if (cs_moi != -1)
            {
                dcu.subIndex++;
                if (dcu.subIndex > dcu.maxsubIndex)
                {
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                    await SendRefreshCommands(dcu, stream, diemDo);
                    dcu.status = STATUS.Online.ToString();
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                }
            }
            else if (cs_moi == -1)
            {
                var loaiBCS_Cmds = clsData.listcmdBCS;
                var loaiTSVH_Cmds = clsData.listcmdTSVH;

                if (loaiBCS_Cmds.Contains(dcu.cmds.cmd_rf) ||
                    dcu.cmds.protocolRF == "DT01MRF_408_4800_8BYTE_V260" ||
                    dcu.cmds.protocolRF == "DT03MRF_408_4800_8BYTE_V260")
                {
                    dcu.retry++;
                    if (dcu.retry > dcu.maxretry)
                    {
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex++;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        await SendRefreshCommands(dcu, stream, diemDo);
                    }
                    else
                    {
                        AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                        if (dcu.cmds.metertype == clsRFSpider.METER_TYPE.ROUTER)
                        {
                            dcu.subIndex--;
                        }
                    }
                }
                else
                {
                    dcu.retry++;
                    if (dcu.retry > dcu.maxretry)
                    {
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.retry = 0;
                        dcu.subIndex++;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        await SendRefreshCommands(dcu, stream, diemDo);
                    }
                    else
                    {
                        AppendLog(ref dcu, true, false, $"Retry lần {dcu.retry}", Color.DarkGray, Color.DarkGray);
                    }
                }

                if (dcu.subIndex > dcu.maxsubIndex)
                {
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.isReading = false;
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.retry = 0;
                    dcu.subIndex = 0;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                    await SendRefreshCommands(dcu, stream, diemDo);
                    dcu.status = STATUS.Online.ToString();
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                }
            }

            await ProcessEvent(stream, amountReadTask, dcu);
        }
        private async Task HandlesettingLoadProfileAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            if (cs_moi == -1)
            {
                dcu.subIndex++;
                if (dcu.subIndex >= dcu.maxsubIndex)
                {
                    SaveJsonResultMulti(dcu, diemDo);
                    dcu.isReading = false;
                    dcu.KetQuaChiSoMoi.Clear();
                    dcu.KetQuaRSSI.Clear();
                    dcu.subIndex = 0;
                    clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                    clsRFSpider.meter_info.init();
                    dcu.status = STATUS.Online.ToString();
                    dcu.Event = EVENT.STOP;
                    ReadingCompleted?.Invoke(this, EventArgs.Empty);
                    if (clsGeneral.mclient_sel?.masterID == dcu.masterID) clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                    AppendLog(ref dcu, true, true, "Kết thúc tiến trình cài đặt công tơ...", Color.Orange, Color.Orange);
                }
            }
            await ProcessEvent(stream, amountReadTask, dcu);
        }
        /// <summary>
        /// Hàm cắt payload theo offset và số byte bỏ cuối
        /// </summary>
        private byte[] ExtractPayload(byte[] data, int offset, int trim)
        {
            if (data.Length <= trim) return Array.Empty<byte>();
            int length = data.Length - trim;
            byte[] payload = new byte[length];
            Array.Copy(data, offset, payload, 0, length);
            return payload;
        }
        private async Task HandleLoadProfileAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            switch (BDPT_METERTYPE)
            {
                case "LANDISGYR":
                    byte[] cmddd = dcu.receivedData.ToArray();
                    modem.dataread_str = BitConverter.ToString(cmddd).Replace("-", "");

                    // Xác định nhóm payload
                    int offset, trim;
                    List<byte[]> targetGroup = null;
                    string payloadTag = "";

                    switch (dcu.subIndex)
                    {
                        case 5: offset = 11; trim = 14; targetGroup = dcu.partialReceivedGroup1; payloadTag = "[1]"; break;
                        case 6: offset = 8; trim = 11; targetGroup = dcu.partialReceivedGroup1; payloadTag = "[2]"; break;
                        case 7: offset = 8; trim = 11; targetGroup = dcu.partialReceivedGroup1; payloadTag = "[3]"; break;
                        case 8: offset = 11; trim = 14; targetGroup = dcu.partialReceivedGroup2; payloadTag = "[4]"; break;
                        case 9: offset = 8; trim = 11; targetGroup = dcu.partialReceivedGroup2; payloadTag = "[5]"; break;
                        default: offset = 0; trim = 0; break;
                    }

                    if (targetGroup != null && cmddd.Length > trim)
                    {
                        // Cắt payload
                        int length = cmddd.Length - trim;
                        byte[] payload = new byte[length];
                        Array.Copy(cmddd, offset, payload, 0, length);

                        // Lưu vào nhóm
                        targetGroup.Add(payload);

                        AppendLog(ref dcu, true, false,
                            $"\r\nPAYLOAD{payloadTag}: {BitConverter.ToString(payload).Replace("-", "")}",
                            Color.Blue, Color.Blue);

                        // Nếu kết thúc nhóm 1 (subIndex=7) → ghép finalPayload1
                        if (dcu.subIndex == 7)
                        {
                            dcu.finalPayload1 = dcu.partialReceivedGroup1.SelectMany(b => b).ToArray();
                            AppendLog(ref dcu, true, false,
                                $"\r\nFINAL PAYLOAD [1]: {BitConverter.ToString(dcu.finalPayload1).Replace("-", "")}",
                                Color.Green, Color.Green);
                        }

                        // Nếu kết thúc nhóm 2 (subIndex=9) → ghép finalPayload2 và phân tích
                        if (dcu.subIndex == 9)
                        {
                            dcu.finalPayload2 = dcu.partialReceivedGroup2.SelectMany(b => b).ToArray();
                            AppendLog(ref dcu, true, false,
                                $"\r\nFINAL PAYLOAD [2]: {BitConverter.ToString(dcu.finalPayload2).Replace("-", "")}",
                                Color.Green, Color.Green);

                            // Phân tích
                            string hexPayload1 = BitConverter.ToString(dcu.finalPayload1).Replace("-", "");
                            string hexPayload2 = BitConverter.ToString(dcu.finalPayload2).Replace("-", "");
                            string logs = clsLANDISGYR.DlmsAnalyzeLoadprofile(hexPayload1, hexPayload2);
                            //foreach (string log in logs)
                            AppendLog(ref dcu, false, true, logs, Color.Blue, Color.Blue);

                            // Reset sau khi hoàn tất
                            SaveJsonResultMulti(dcu, diemDo);
                            dcu.isReading = false;
                            dcu.KetQuaChiSoMoi.Clear();
                            dcu.KetQuaRSSI.Clear();
                            dcu.subIndex = 0;
                            dcu.partialReceivedGroup1.Clear();
                            dcu.partialReceivedGroup2.Clear();
                            dcu.finalPayload1 = Array.Empty<byte>();
                            dcu.finalPayload2 = Array.Empty<byte>();
                            clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                            clsRFSpider.meter_info.init();
                            dcu.status = STATUS.Online.ToString();
                            dcu.Event = EVENT.STOP;
                            ReadingCompleted?.Invoke(this, EventArgs.Empty);

                            if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                                clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;

                            AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                        }
                    }

                    dcu.subIndex++;
                    await ProcessEvent(stream, amountReadTask, dcu);
                    break;
                default:
                    // Đang ở bước đọc gói load profile
                    if (dcu.subIndex == 6)
                    {
                        // Chưa đọc hết gói trong ngày
                        if (modem.indexPacket < modem.maxPackets)
                        {
                            if (dcu.LoadProfilePackets == null)
                                dcu.LoadProfilePackets = new List<string>();

                            int start = dcu.asciicmd_mahoa.IndexOf('(');
                            int end = dcu.asciicmd_mahoa.IndexOf(')');

                            if (start != -1 && end != -1 && end > start)
                            {
                                string extracted = dcu.asciicmd_mahoa.Substring(start + 1, end - start - 1);
                                dcu.LoadProfilePackets.Add(extracted);
                            }
                            byte[] nextCmd;
                            if (BDPT_METERTYPE == "ELSTER")
                            {
                                nextCmd = getCmdPacketLoad_elster(ref modem, cmdReadProfileValue_elster);
                            }
                            else
                            {
                                nextCmd = getCmdPacketLoad(ref modem, cmdReadProfileValue);
                            }
                            await stream.WriteAsync(nextCmd, 0, nextCmd.Length);
                            AppendLog(ref dcu, true, false, $"{BitConverter.ToString(nextCmd).Replace("-", "")}", Color.Red, Color.Red);
                            string asciiCmd = Encoding.ASCII.GetString(nextCmd);
                            AppendLog(ref dcu, true, false, asciiCmd, Color.Red, Color.Red);
                            return; // không tăng subIndex
                        }
                        else
                        {
                            // Hết toàn bộ ngày và gói
                            if (dcu.LoadProfilePackets == null)
                                dcu.LoadProfilePackets = new List<string>();

                            int start = dcu.asciicmd_mahoa.IndexOf('(');
                            int end = dcu.asciicmd_mahoa.IndexOf(')');

                            if (start != -1 && end != -1 && end > start)
                            {
                                string extracted = dcu.asciicmd_mahoa.Substring(start + 1, end - start - 1);
                                dcu.LoadProfilePackets.Add(extracted);
                            }

                            dcu.subIndex++;
                        }
                    }
                    else
                    {
                        // Không phải bước load profile → tăng subIndex bình thường
                        dcu.subIndex++;
                    }
                    // Nếu đã hoàn tất tất cả các bước
                    if (dcu.subIndex > 6) // 6 là bước cuối load profile
                    {
                        string fullProfileData = string.Join("", dcu.LoadProfilePackets);
                        dcu.LoadProfilePackets.Clear();
                        AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\t{fullProfileData}", Color.Blue, Color.Blue);
                        List<Meters.LoadProfile> loadPros = new List<Meters.LoadProfile>();

                        // Chuyển toàn bộ chuỗi Hex thành byte array
                        byte[] bytes_load_profile = new byte[fullProfileData.Length / 2];

                        for (int i = 0; i < bytes_load_profile.Length; i++)
                        {
                            // Lấy 2 ký tự Hex 1 lần
                            bytes_load_profile[i] = Convert.ToByte(fullProfileData.Substring(i * 2, 2), 16);
                        }

                        Meters.DiemDo diemDo1 = new Meters.DiemDo();
                        string[] logs;
                        if (BDPT_METERTYPE == "ELSTER")
                        {
                            logs = clsELSTER.analyzeLoadprofile(bytes_load_profile);
                        }
                        else
                        {
                            logs = clsDT03M.AnalyzeLoadprofile(diemDo1, bytes_load_profile);

                        }
                        foreach (string log in logs)
                        {
                            AppendLog(ref dcu, true, false, log, Color.Blue, Color.Blue);   // hiển thị từng dòng
                        }
                        SaveJsonResultMulti(dcu, diemDo);
                        dcu.isReading = false;
                        dcu.KetQuaChiSoMoi.Clear();
                        dcu.KetQuaRSSI.Clear();
                        dcu.subIndex = 0;
                        clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                        clsRFSpider.meter_info.init();
                        dcu.status = STATUS.Online.ToString();
                        dcu.Event = EVENT.STOP;
                        ReadingCompleted?.Invoke(this, EventArgs.Empty);

                        if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                            clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                        AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
                    }

                    await ProcessEvent(stream, amountReadTask, dcu);

                    break;
            }
        }
        string[] logs;
        private async Task HandleEvent_ELSTERAsync(clientmanagerV4 dcu, DIEMDO diemDo, NetworkStream stream, Task<int> amountReadTask, decimal cs_moi, string cs_string, int rssi)
        {
            // Đang ở bước đọc gói load profile
            byte[] bytes_load_profile = dcu.receivedData.ToArray();
            if (dcu.subIndex == 4)
            {
                string commandCode = securityCmdCodes[dcu.subIndex_event_elster];
                int start = dcu.asciicmd_mahoa.IndexOf('(');
                int end = dcu.asciicmd_mahoa.IndexOf(')');
                string inside = "";
                if (start != -1 && end != -1 && end > start)
                {
                    inside = dcu.asciicmd_mahoa.Substring(start + 1, end - start - 1);
                }
                string line = $"{commandCode}\t{inside}";

                // Lưu tạm vào list để sau này phân tích
                if (dcu.SecurityLines == null)
                    dcu.SecurityLines = new List<string>();
                dcu.SecurityLines.Add(line);

                dcu.subIndex_event_elster++;
            }
            else
            {
                // Không phải bước load profile → tăng subIndex bình thường
                dcu.subIndex++;
            }
            // Nếu đã hoàn tất tất cả các bước
            if (dcu.subIndex_event_elster >= cmdSecurities.Length) // 6 là bước cuối load profile
            {
                Meters.DiemDo diemDo1 = new Meters.DiemDo();
                // Ghép tất cả các dòng lại thành "dataHex" đúng format
                string dataHex = string.Join("\n", dcu.SecurityLines);

                // Gọi hàm phân tích
                string[] logs = clsELSTER.analyzeSecurity(dataHex);

                // Xuất log
                foreach (string log in logs)
                {
                    AppendLog(ref dcu, true, false, log, Color.Blue, Color.Blue);
                }
                SaveJsonResultMulti(dcu, diemDo);
                dcu.isReading = false;
                dcu.KetQuaChiSoMoi.Clear();
                dcu.KetQuaRSSI.Clear();
                dcu.subIndex = 0;
                dcu.subIndex_event_elster = 0;
                clsRFSpider.meter_info = new clsRFSpider.MeterInfor();
                clsRFSpider.meter_info.init();
                dcu.status = STATUS.Online.ToString();
                dcu.Event = EVENT.STOP;
                ReadingCompleted?.Invoke(this, EventArgs.Empty);

                if (clsGeneral.mclient_sel?.masterID == dcu.masterID)
                    clsGeneral.mclient_sel.mStation.STATUS = RF_SPIDER_VER2.STATUS.Online;
                AppendLog(ref dcu, true, true, "Kết thúc tiến trình Đọc...", Color.Orange, Color.Orange);
            }

            await ProcessEvent(stream, amountReadTask, dcu);
        }
        #endregion

        #region CÁC SUB KHI ĐỌC CÓ INDEX VÀ PACKET
        private async Task<int> HandleBillingReadAsync(clientmanagerV4 dcu, DIEMDO diemDo, string processedSpiderRead, byte cmdType)
        {
            // Khởi tạo danh sách kỳ nếu chưa có
            if (dcu.indexBillingList == null || dcu.indexBillingList.Count == 0)
            {
                dcu.indexBillingList = Enumerable.Range(1, 36).Select(x => (byte)x).ToList();
                dcu.currentBillingIdx = 0;
                dcu.maxsubIndex = dcu.indexBillingList.Count;
            }

            // Khởi tạo cờ lần đầu
            if (!dcu.flags.ContainsKey("isReadingTimeOfBilling"))
            {
                dcu.flags["isReadingTimeOfBilling"] = false;
            }

            isReadingTimeOfBilling = (bool)dcu.flags["isReadingTimeOfBilling"];
            byte packetBilling = dcu.indexBillingList[dcu.currentBillingIdx];
            clsRFSpider.packet = packetBilling;
            byte[] twoByteIndexBilling = isReadingTimeOfBilling
                ? new byte[] { 0x00, packetBilling }
                : new byte[] { 0x01, packetBilling };
            clsRFSpider.index = twoByteIndexBilling[0];
            byte sub_mesh_cmd = clsRFSpider.SUBCMD_READ_BILLING_DATA;
            dcu.cmds = await dcu.GenerateCommandFromDiemDo_mesh(diemDo, processedSpiderRead, cmdType, sub_mesh_cmd, twoByteIndexBilling);
            dcu.cmds.billingIndex = twoByteIndexBilling;
            clsRFSpider.index_billing = twoByteIndexBilling;
            // Lật cờ giữa dữ liệu <-> thời gian
            dcu.flags["isReadingTimeOfBilling"] = !isReadingTimeOfBilling;
            return 1;
        }
        private byte GetSubCmdForMesh(int subIndex)
        {
            return subIndex switch
            {
                //0 => 0x4D,
                0 => 0x21,
                1 => 0xA2,
                2 => 0xA3,
                3 => 0xA4,
                4 => 0xA5,
                5 => 0x23,
                6 => 0xA6,
                7 => 0x3A,
                8 => 0x27,
                9 => 0x4E,
                _ => 0x00                // Kết thúc
            };
        }
        private byte GetSubCmdForMesh_tariff(int subIndex)
        {
            return subIndex switch
            {
                //0 => 0x4D,
                0 => 0x3E,  // 16 bước cho 0x3E (tariff energy 32 biểu giá) 16
                1 => 0x3F, // 8 bước cho 0x3F (tariff maxdemand) 8
                _ => 0x00                // Kết thúc
            };
        }
        #endregion

        #region HÀM LẤY ĐƯỜNG DẪN
        private string GetProcessedSpiderRead_mesh(DIEMDO diemDo, clientmanagerV4 dcu)
        {
            if (string.IsNullOrEmpty(diemDo?.SPIDER_READ))
            {
                // Trường hợp SPIDER_READ rỗng → trả về serial DCU
                return dcu.masterID.ToString() ?? "";
            }

            string beforeColon = diemDo.SPIDER_READ.Split(':')[0];
            string[] nodes = beforeColon.Split(';', StringSplitOptions.RemoveEmptyEntries)
                                        .Select(n => n.Trim())
                                        .ToArray();

            int nodeCount = nodes.Length;
            string serialCto = diemDo.SERY_CTO.ToString();

            if (nodeCount == 0)
            {
                return serialCto;
            }
            else if (nodeCount == 1)
            {
                return nodes[0];
            }
            else if (nodeCount == 2 && nodes[1] == serialCto)
            {
                return nodes[0];
            }
            else if (nodeCount > 2 && nodes[^1] == serialCto)
            {
                return string.Join(";", nodes.Take(nodes.Length - 1));
            }
            else
            {
                return string.Join(";", nodes);
            }
        }
        public static string ProcessSpiderReadPath(string spiderRead, string seryCto, string versionRF, UInt32 masterID)
        {
            if (string.IsNullOrEmpty(spiderRead))
                return "";

            string beforeColon = spiderRead.Split(':')[0];
            string[] nodes = beforeColon.Split(';');

            bool isSpecialVersion = versionRF == "DT01MRF_408_4800_8BYTE_V260" ||
                                   versionRF == "DT03MRF_408_4800_8BYTE_V260";

            if (nodes.Length == 1)
            {
                return isSpecialVersion ? masterID.ToString() : "";
            }
            else if (nodes.Length == 2 && nodes[1] == seryCto)
            {
                return isSpecialVersion ? masterID.ToString() : "";
            }
            else if (nodes.Length > 2 && nodes[^1] == seryCto)
            {
                string[] trimmed = new string[nodes.Length - 1];
                Array.Copy(nodes, trimmed, nodes.Length - 1);
                return string.Join(";", trimmed);
            }
            else
            {
                return beforeColon;
            }
        }
        #endregion

        #region Lưu giá trị đọc được vào file json
        private string GetFullValue(clientmanagerV4 dcu, byte cmd)
        {
            if (dcu.KetQuaChiSoMoi.TryGetValue(cmd, out var resultList))
            {
                if (resultList == null || resultList.Count == 0)
                    return "null";

                List<string> valueParts = new List<string>();

                foreach (var result in resultList)
                {
                    bool hasNumber = result.GiaTriSo > 0; // Chỉ nhận số > 0
                    bool hasString = !string.IsNullOrEmpty(result.GiaTriChuoi);

                    if (hasNumber && hasString)
                        valueParts.Add($"{result.GiaTriSo} | {result.GiaTriChuoi}");
                    else if (hasNumber)
                        valueParts.Add(result.GiaTriSo.ToString());
                    else if (hasString)
                        valueParts.Add(result.GiaTriChuoi);
                }

                if (valueParts.Count > 0)
                    return string.Join("; ", valueParts); // Ngăn cách các kết quả bằng dấu ;
            }

            return "null";
        }
        private void SaveJsonResultMulti(clientmanagerV4 dcu, DIEMDO diemdo)
        {

            string ma_ddo = diemdo.MA_DDO ?? "UNKNOWN";
            string sery_cto = diemdo.SERY_CTO ?? "UNKNOWN";
            string timestamp = DateTime.Now.ToString("dd-MM-yyyy_HH-mm-ss");
            string meterType = diemdo.METER_TYPE ?? "UNKNOWN";
            string spiderPath = diemdo.SPIDER_PATH ?? "null";
            string spider_read = diemdo.SPIDER_READ ?? "1";
            string dateTimeStr = DateTime.Now.ToString("MM/dd/yyyy hh:mm:ss tt");
            string pass_read = diemdo.PASS_READ.ToString() ?? "UNKNOWN";
            string total_read = diemdo.TOTAL_READ.ToString() ?? "UNKNOWN";
            int level = diemdo.SPIDER_LEVEL;
            int rssidBm = clsRFSpider.meter_info.rssidBm;
            string imei = dcu?.mStation?.IMEI ?? "UNKNOWN";
            string id_dcu = dcu?.masterID.ToString() ?? "UNKNOWN";
            string basePath = @"C:\Private$";

            // === Ghi file IM_EX.res            

            string im_ex_content = string.Format(
                "{0}\t{1}\t{2}\t{3}\t{4}\t{5}\t{6}\t{7}\t{8}\t{9}\t{10}\t{11}",
                meterType,
                ma_ddo,
                sery_cto,
                clsRFSpider.meter_info.kWhImport.ToString("0.###"),
                clsRFSpider.meter_info.kWhExport.ToString("0.###"),
                //GetFullValue(dcu, clsRFSpider.CMD_READ),
                //GetFullValue(dcu, clsRFSpider.CMD_READ_KWH_EXPORT),
                spiderPath,
                dateTimeStr,
                rssidBm,
                level,
                pass_read,
                total_read,
                spider_read
            );
            string path1 = Path.Combine(basePath, "IM_EX", $"{timestamp}_{ma_ddo}_{sery_cto}.res");
            Directory.CreateDirectory(Path.GetDirectoryName(path1));
            File.WriteAllText(path1, im_ex_content, Encoding.UTF8);

            // === Ghi file RTC.res
            string rtc_content = string.Format(
                "{0}\t{1}\t{2}\t{3}",
                ma_ddo,
                sery_cto,
                dateTimeStr,
                GetFullValue(dcu, clsRFSpider.CMD_RF_READ_RTC)
            );
            string path2 = Path.Combine(basePath, "RTC", $"{timestamp}_{ma_ddo}_{sery_cto}.res");
            Directory.CreateDirectory(Path.GetDirectoryName(path2));
            File.WriteAllText(path2, rtc_content, Encoding.UTF8);

            // === Ghi file DCU_STATUS.res
            string dcu_content = string.Format(
                "{0}\t{1}\t{2}",
                imei,
                id_dcu,
                dateTimeStr
            );

            string path3 = Path.Combine(basePath, "DCU_STATUS", $"{timestamp}_{ma_ddo}_{sery_cto}.res");
            Directory.CreateDirectory(Path.GetDirectoryName(path3));
            File.WriteAllText(path3, dcu_content, Encoding.UTF8);

            // === Ghi file INSTANEOUS.res
            string instaneous_content = string.Format(
                "{0}\t{1}\t{2}\t{3}\t{4}\t{5}\t{6}\t{7}",
                ma_ddo,
                sery_cto,
                clsRFSpider.meter_info.VoltageA.ToString("0.###"),
                clsRFSpider.meter_info.VoltageB.ToString("0.###"),
                clsRFSpider.meter_info.VoltageC.ToString("0.###"),
                clsRFSpider.meter_info.kWhImport.ToString("0.###"),
                //GetFullValue(dcu, clsRFSpider.CMD_READ_PHASE_A_VOLTAGE),
                //GetFullValue(dcu, clsRFSpider.CMD_READ_PHASE_B_VOLTAGE),
                //GetFullValue(dcu, clsRFSpider.CMD_READ_PHASE_C_VOLTAGE),
                //GetFullValue(dcu, clsRFSpider.CMD_READ),
                dateTimeStr,
                spider_read
            );

            string path4 = Path.Combine(basePath, "INSTANEOUS", $"{timestamp}_{ma_ddo}_{sery_cto}.res");
            Directory.CreateDirectory(Path.GetDirectoryName(path4));
            File.WriteAllText(path4, instaneous_content, Encoding.UTF8);

            // === Ghi file BILLING.res
            string billing_content = string.Format(
                "{0}\t{1}\t{2}\t{3}\t{4}\t{5}\t{6}\t{7}\t{8}\t{9}\t{10}\t{11}\t{12}\t{13}\t{14}\t{15}\t{16}\t{17}\t{18}\t{19}\t{20}\t{21}\t{22}\t{23}\t{24}\t{25}\t{26}\t{27}\t{28}\t{29}\t{30}\t{31}",
                ma_ddo,
                sery_cto,
                GetFullValue(dcu, clsRFSpider.CMD_READ_MESH),
                dateTimeStr, "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1"
            );

            string path5 = Path.Combine(basePath, "BILLING", $"{timestamp}_{ma_ddo}_{sery_cto}.res");
            Directory.CreateDirectory(Path.GetDirectoryName(path5));
            File.WriteAllText(path5, billing_content, Encoding.UTF8);

            // === Ghi file TARIFF.res
            string tariff_content = string.Format(
                "{0}\t{1}\t{2}\t{3}\t{4}\t{5}\t{6}\t{7}\t{8}\t{9}\t{10}\t{11}\t{12}\t{13}\t{14}\t{15}\t{16}\t{17}\t{18}\t{19}\t{20}\t{21}\t{22}\t{23}\t{24}\t{25}\t{26}\t{27}\t{28}\t{29}\t{30}\t{31}",
                ma_ddo,
                sery_cto,
                GetFullValue(dcu, clsRFSpider.CMD_READ_TARIFF_INFO),
                dateTimeStr, "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1"

            );

            string path6 = Path.Combine(basePath, "TARIFF", $"{timestamp}_{ma_ddo}_{sery_cto}.res");
            Directory.CreateDirectory(Path.GetDirectoryName(path6));
            File.WriteAllText(path6, tariff_content, Encoding.UTF8);
        }
        private void Save_Json_Result(clientmanagerV4 dcu, DIEMDO diemdo, clsRFSpider.MeterInfor meterInfor, bool isDiscovery)
        {
            try
            {
                string ma_ddo = diemdo.MA_DDO ?? "UNKNOWN";
                string sery_cto = diemdo.SERY_CTO ?? "UNKNOWN";
                string timestamp = DateTime.Now.ToString("dd-MM-yyyy_HH-mm-ss");
                string meterType = diemdo.METER_TYPE ?? "UNKNOWN";
                string spiderPath = diemdo.SPIDER_PATH ?? "null";
                string spider_read = diemdo.SPIDER_READ ?? "1";
                string dateTimeStr = DateTime.Now.ToString("MM/dd/yyyy hh:mm:ss tt");
                string pass_read = diemdo.PASS_READ.ToString() ?? "UNKNOWN";
                string total_read = diemdo.TOTAL_READ.ToString() ?? "UNKNOWN";
                int level = diemdo.SPIDER_LEVEL;
                int rssidBm = clsRFSpider.meter_info.rssidBm;
                string imei = dcu?.mStation?.IMEI ?? "UNKNOWN";
                string id_dcu = dcu?.masterID.ToString() ?? "UNKNOWN";
                string basePath = @"C:\Private$";

                if (isDiscovery) // chỉ lưu Import kWh
                {
                    string im_ex_content = string.Format(
                    "{0}\t{1}\t{2}\t{3}\t{4}\t{5}\t{6}\t{7}\t{8}\t{9}\t{10}\t{11}",
                    meterType,
                    ma_ddo,
                    sery_cto,
                    meterInfor.kWhImport.ToString(),
                    "-1",
                    spiderPath,
                    dateTimeStr,
                    rssidBm,
                    level,
                    pass_read,
                    total_read,
                    spider_read
                );
                    string path1 = Path.Combine(basePath, "IM_EX", $"{timestamp}_{ma_ddo}_{sery_cto}.res");
                    Directory.CreateDirectory(Path.GetDirectoryName(path1));
                    File.WriteAllText(path1, im_ex_content, Encoding.UTF8);
                }
            }
            catch (Exception ex)
            {

            }

        }
        #endregion

        #region HÀM GHI FILE
        private void LogSIMInfo(int stationIndex, string simValue)
        {
            try
            {
                string simLogPath = "ThongTinSIM.txt";
                string logEntry = $"{DateTime.Now:yyyy-MM-dd HH:mm:ss}\tSTATION_IDX: {stationIndex}\tSIM: {simValue}";
                File.AppendAllText(simLogPath, logEntry + Environment.NewLine);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ghi thông tin SIM thất bại: {ex.Message}");
            }
        }
        private void LogRawBytes(string serial, string direction, byte[] data)
        {
            try
            {
                string logPath = "ByteDataLog.txt";
                string time = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss.fff");
                string hex = BitConverter.ToString(data).Replace("-", "");
                string logLine = $"{time}\t[{direction}]\tSerial: {serial}\tData: {hex}";
                File.AppendAllText(logPath, logLine + Environment.NewLine);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ghi log byte thất bại: {ex.Message}");
            }
        }
        #endregion

        #region HÀM HIỂN THỊ THÔNG SỐ LÊN GIAO DIỆN      
        private async Task Update_Status(clientmanagerV4 dcu, STATUS status)
        {
            dcu.mStation.STATUS = status;
            if (status == STATUS.Offline)
            {
                //clsLogFile.AppendRichTextBox(ref dcu.rtbinfo, $"{DateTime.Now} \t===>\tDCU đã mất kết nối (offline)", Color.Red);
                AppendLog(ref dcu, true, false, $"{DateTime.Now} \t===>\tDCU đã mất kết nối (offline)", Color.Red, Color.Red);
            }
            dcu.mStation.UPDATE_TIME = DateTime.Now;
            Console.WriteLine($"{DateTime.Now.ToString()}\t {dcu.masterID}\tOFF\t{dcu.mStation.COUNTER_CONNECTED}");
        }
        private async Task Update_Chiso(DIEMDO diemdo, clsRFSpider.MeterInfor meterinfor)
        {
            try
            {
                if (meterinfor.kWhImport >= 0)
                {
                    diemdo.CS_MOI = meterinfor.kWhImport.ToString();
                    diemdo.NGAY_CHOT = DateTime.Now;
                    diemdo.NGAYGIO = DateTime.Now;
                }
                else
                {
                    diemdo.CS_MOI = "FAIL";
                }
                clsGeneral.mclient_sel?.gridViewItem?.RefreshData();
            }
            catch (Exception)
            {

            }
        }
        private string BuildCommandLog(string serial, byte cmd_rf, decimal cs_moi, string cs_string, int rssi, string protocolRF, clientmanagerV4 dcu)
        {
            string label;
            string folder;

            if (dcu.cmds.metertype == clsRFSpider.METER_TYPE.DDS26D)
            {
                switch (cmd_rf)
                {
                    case clsRFSpider.CMD_STAR_SCRIP_KWH_IMPORT: label = "IM_KWH"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_STAR_SCRIP_UART: label = "IM_KWH"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_STAR: label = "IM_KWH"; folder = "IM_EX"; break;

                    default:
                        label = $"UNKNOWN_{cmd_rf}";
                        folder = "UNKNOWN";
                        break;
                }
            }
            else if (dcu.cmds.metertype == clsRFSpider.METER_TYPE.DTS27)
            {
                switch (cmd_rf)
                {
                    case clsRFSpider.CMD_READ_STAR: label = "IM_KWH"; folder = "IM_EX"; break;
                    default:
                        label = $"UNKNOWN_{cmd_rf}";
                        folder = "UNKNOWN";
                        break;
                }
            }
            else
            {
                switch (cmd_rf)
                {
                    // IM_EX group
                    //case clsRFSpider.CMD_READ_MESH: label = "MESH"; break;               
                    case clsRFSpider.CMD_READ: label = "IM_KWH"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_ALL: label = "IM_KWH"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_KWH_EXPORT: label = "EX_KWH"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_VAR_IMPORT: label = "VAR_IM"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_VAR_EXPORT: label = "VAR_EX"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_Q1: label = "Q1"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_Q2: label = "Q2"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_Q3: label = "Q3"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_Q4: label = "Q4"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_T1: label = "T1"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_T2: label = "T2"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_T3: label = "T3"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_T4: label = "T4"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_T5: label = "T5"; folder = "IM_EX"; break;
                    case clsRFSpider.CMD_READ_T6: label = "T6"; folder = "IM_EX"; break;

                    // INSTANTANEOUS group
                    case clsRFSpider.CMD_READ_PHASE_A_CURRENT: label = "CURRENT_A"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_READ_PHASE_B_CURRENT: label = "CURRENT_B"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_READ_PHASE_C_CURRENT: label = "CURRENT_C"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_READ_PHASE_A_VOLTAGE: label = "VOLTAGE_A"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_READ_PHASE_B_VOLTAGE: label = "VOLTAGE_B"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_READ_PHASE_C_VOLTAGE: label = "VOLTAGE_C"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_READ_PHASE_A_POWER_FACTOR: label = "PF_A"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_READ_PHASE_B_POWER_FACTOR: label = "PF_B"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_READ_PHASE_C_POWER_FACTOR: label = "PF_C"; folder = "INSTANTANEOUS"; break;
                    case clsRFSpider.CMD_RF_READ_RTC: label = "RTC"; folder = "RTC"; break;
                    case clsRFSpider.CMD_READ_VERSION: label = "VERSION"; folder = "VERSION"; break;

                    case clsRFSpider.CMD_RF_READ:
                        if (dcu.cmds.sub_cmd == clsRFSpider.SUBCMD_MESH_READ_EVENTS)
                        {
                            label = "";
                        }
                        else
                        {
                            label = "TU/TI";
                        }
                        folder = "RTC";
                        break;

                    default:
                        if (cmd_rf == clsRFSpider.CMD_READ_MESH && dcu.cmds.sub_cmd == clsRFSpider.SUBCMD_READ_BILLING_DATA)
                        {
                            if (dcu.cmds.billingIndex != null && dcu.cmds.billingIndex.Length >= 2)
                            {
                                int kyChot = dcu.cmds.billingIndex[1]; // byte thứ 2 chứa số kỳ chốt
                                label = $"MONTH_BILLING {kyChot}";
                            }
                            else
                            {
                                label = "MONTH_BILLING";
                            }
                            folder = "BILLING_DATA";
                        }
                        else if (cmd_rf == clsRFSpider.CMD_READ_TARIFF_INFO && dcu.cmds.sub_cmd == clsRFSpider.SUBCMD_READ_TARIFF_ALL)
                        {
                            if (dcu.cmds.tariffindex != null)
                            {
                                byte bieugia = dcu.cmds.tariffindex;
                                label = $"T{bieugia}";
                            }
                            else
                            {
                                label = "T?";
                            }
                            folder = "TARIFF_DATA";
                        }
                        //else if (cmd_rf == clsRFSpider.CMD_READ_MESH && (dcu.cmds.sub_cmd == clsRFSpider.SUBCMD_MESH_ENERGY || dcu.cmds.sub_cmd == clsRFSpider.SUBCMD_NOSUB))
                        else if (cmd_rf == clsRFSpider.CMD_READ_MESH)
                        {
                            label = $"";
                            folder = "ENERGY_DATA";
                        }
                        else
                        {
                            label = $"UNKNOWN_{cmd_rf}";
                            folder = "UNKNOWN";
                        }
                        break;

                }
            }
            //return $"{label}: {(string.IsNullOrEmpty(cs_string) ? (cs_moi == -1 ? "null" : cs_moi.ToString()) : cs_string)},\tRSSI Meter: {rssi} dBm";
            return label;
        }
        #endregion

        #region HIỂN THỊ LOG
        public static void AppendLog(ref clientmanagerV4 dcu, bool check_rtblog, bool check_rtbinfor, string log, Color color_rtblog, Color color_rtbinfor)
        {
            try
            {
                if (dcu.lastLog == log) return;
                dcu.lastLog = log;
                if (check_rtblog)
                    clsLogFile.AppendRichTextBox(ref dcu.rtblog, log, color_rtblog);
                if (check_rtbinfor)
                    clsLogFile.AppendRichTextBox(ref dcu.rtbinfo, log, color_rtbinfor);
            }
            catch (Exception)
            {

            }
        }
        public static void ClearLog(clientmanagerV4 dcu, bool clear_rtblog, bool clear_rtbinfor)
        {
            try
            {
                if (clear_rtblog && dcu?.rtblog != null)
                {
                    if (dcu.rtblog.InvokeRequired)
                    {
                        dcu.rtblog.Invoke(new Action(() => dcu.rtblog.Clear()));
                    }
                    else
                    {
                        dcu.rtblog.Clear();
                    }
                }

                if (clear_rtbinfor && dcu?.rtbinfo != null)
                {
                    if (dcu.rtbinfo.InvokeRequired)
                    {
                        dcu.rtbinfo.Invoke(new Action(() => dcu.rtbinfo.Clear()));
                    }
                    else
                    {
                        dcu.rtbinfo.Clear();
                    }
                }
            }
            catch (Exception)
            {
                // Log exception nếu cần
            }
        }
        private void AppendKetQuaDocChiSo(ref clientmanagerV4 dcu, DIEMDO diemDo, byte cmdType, int rssi, decimal cs_moi)
        {
            if (cs_moi != -1 && cs_moi != -10101010)
            {
                switch (cmdType)
                {
                    case clsRFSpider.CMD_READ_ALL:
                        AppendLog(ref dcu, true, false, $"Đọc kWh Import - kWh Export", Color.Black, Color.Black);
                        if (!dcu.hasLoggedSuccess)
                        {
                            diemDo.PASS_READ++;
                            dcu.hasLoggedSuccess = true;
                        }
                        AppendLog(ref dcu, true, false, $"kWhImport: {clsRFSpider.meter_info.kWhImport}; kWhExport: {clsRFSpider.meter_info.kWhExport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        string warningResult = "";
                        if (clsRFSpider.meter_info.warning != 0)
                        {
                            clsRFSpider.analyze_warning(diemDo.METER_TYPE, diemDo.VERSION_RF, (UInt16)clsRFSpider.meter_info.warning, ref warningResult);
                        }
                        AppendLog(ref dcu, true, false, $"Warning: {warningResult}", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_MESH:
                        switch (dcu.cmds.sub_cmd)
                        {
                            case clsRFSpider.SUBCMD_MESH_ENERGY:
                                AppendLog(ref dcu, true, false, $"Đọc kWh Import - kWh Export", Color.Black, Color.Black);
                                if (!dcu.hasLoggedSuccess)
                                {
                                    diemDo.PASS_READ++;
                                    dcu.hasLoggedSuccess = true;
                                }
                                AppendLog(ref dcu, true, false, $"kWhImport: {clsRFSpider.meter_info.kWhImport}; kWhExport: {clsRFSpider.meter_info.kWhExport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                                break;
                            case clsRFSpider.SUBCMD_MESH_TARIFF_REG_VALUE:
                                if (clsRFSpider.index_tariff >= 0x00 && clsRFSpider.index_tariff <= 0x32)
                                {
                                    LogTariffInfo(ref dcu, clsRFSpider.index_tariff, clsRFSpider.meter_info.data, rssi, clsRFSpider.meter_info.warning.ToString(), clsRFSpider.meter_info.tamper.ToString(), diemDo.SPIDER_READ);
                                }
                                break;
                            case clsRFSpider.SUBCMD_READ_BILLING_DATA:
                                if (clsRFSpider.index_billing.Length >= 2 && clsRFSpider.index_billing[0] >= 0x00 && clsRFSpider.index_billing[0] <= 0x01 && clsRFSpider.index_billing[1] >= 0x00 && clsRFSpider.index_billing[1] <= 0x36)
                                {
                                    int intIndex = (clsRFSpider.index_billing.Length == 2) ? (clsRFSpider.index_billing[0] << 8) + clsRFSpider.index_billing[1] : clsRFSpider.index_billing[0];
                                    LogBIllingInfo(ref dcu, intIndex, clsRFSpider.meter_info.data, rssi, clsRFSpider.meter_info.warning.ToString(), clsRFSpider.meter_info.tamper.ToString(), diemDo.SPIDER_READ);
                                }
                                break;
                        }
                        break;
                    case clsRFSpider.CMD_READ_STAR:
                        AppendLog(ref dcu, true, false, $"Đọc kWh Import", Color.Black, Color.Black);
                        if (!dcu.hasLoggedSuccess)
                        {
                            diemDo.PASS_READ++;
                            dcu.hasLoggedSuccess = true;
                        }
                        AppendLog(ref dcu, true, false, $"kWhImport: {clsRFSpider.meter_info.kWhImport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ:
                        AppendLog(ref dcu, true, false, $"Đọc kWh Import", Color.Black, Color.Black);
                        if (!dcu.hasLoggedSuccess)
                        {
                            diemDo.PASS_READ++;
                            dcu.hasLoggedSuccess = true;
                        }
                        AppendLog(ref dcu, true, false, $"kWhImport: {clsRFSpider.meter_info.kWhImport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_KWH_EXPORT:
                        AppendLog(ref dcu, true, false, $"Đọc kWh Import - kWh Export", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"kWhImport: {clsRFSpider.meter_info.kWhImport}; kWhExport: {clsRFSpider.meter_info.kWhExport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_VAR_IMPORT:
                        AppendLog(ref dcu, true, false, $"Đọc Var Import", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"varImport: {clsRFSpider.meter_info.varImport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_VAR_EXPORT:
                        AppendLog(ref dcu, true, false, $"Đọc Var Export", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"varExport: {clsRFSpider.meter_info.varExport}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    //case clsRFSpider.SUBCMD_MESH_Q1_Q2:
                    case clsRFSpider.CMD_READ_Q1:
                    case clsRFSpider.CMD_READ_Q2:
                        AppendLog(ref dcu, true, false, $"Đọc Q1 - Q2", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Q1: {clsRFSpider.meter_info.readQ1}; Q2: {clsRFSpider.meter_info.readQ2}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    //case clsRFSpider.SUBCMD_MESH_Q3_Q4:
                    case clsRFSpider.CMD_READ_Q3:
                    case clsRFSpider.CMD_READ_Q4:
                        AppendLog(ref dcu, true, false, $"Đọc Q3 - Q4", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Q3: {clsRFSpider.meter_info.readQ3}; Q4: {clsRFSpider.meter_info.readQ4}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_T1:
                        AppendLog(ref dcu, true, false, $"Đọc biểu giá T1", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"T1: {clsRFSpider.meter_info.readT1}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_T2:
                        AppendLog(ref dcu, true, false, $"Đọc biểu giá T2", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"T2: {clsRFSpider.meter_info.readT2}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_T3:
                        AppendLog(ref dcu, true, false, $"Đọc biểu giá T3", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"T3: {clsRFSpider.meter_info.readT3}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_T4:
                        AppendLog(ref dcu, true, false, $"Đọc biểu giá T4", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"T4: {clsRFSpider.meter_info.readT4}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_T5:
                        AppendLog(ref dcu, true, false, $"Đọc biểu giá T5", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"T5: {clsRFSpider.meter_info.readT5}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_T6:
                        AppendLog(ref dcu, true, false, $"Đọc biểu giá T6", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"T6: {clsRFSpider.meter_info.readT1}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_RF_READ_RTC:
                        AppendLog(ref dcu, true, false, $"Đọc RTC", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"RTC: {clsRFSpider.meter_info.rtc}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_VERSION:
                        AppendLog(ref dcu, true, false, $"Đọc Version", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Version: {clsRFSpider.meter_info.fwVersion}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_A_CURRENT:
                        AppendLog(ref dcu, true, false, $"Đọc dòng điện pha A", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Current A: {clsRFSpider.meter_info.CurrentA}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_B_CURRENT:
                        AppendLog(ref dcu, true, false, $"Đọc dòng điện pha B", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Current B: {clsRFSpider.meter_info.CurrentB}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_C_CURRENT:
                        AppendLog(ref dcu, true, false, $"Đọc dòng điện pha C", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Current C: {clsRFSpider.meter_info.CurrentC}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_A_VOLTAGE:
                        AppendLog(ref dcu, true, false, $"Đọc điện áp pha A", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Voltage A: {clsRFSpider.meter_info.VoltageA}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_B_VOLTAGE:
                        AppendLog(ref dcu, true, false, $"Đọc điện áp pha B", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Voltage B: {clsRFSpider.meter_info.VoltageB}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_C_VOLTAGE:
                        AppendLog(ref dcu, true, false, $"Đọc điện áp pha C", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"Voltage C: {clsRFSpider.meter_info.VoltageC}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_A_POWER_FACTOR:
                        AppendLog(ref dcu, true, false, $"Đọc Power factor A", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"PF A: {clsRFSpider.meter_info.PowerFactorA}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_B_POWER_FACTOR:
                        AppendLog(ref dcu, true, false, $"Đọc Power factor B", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"PF B: {clsRFSpider.meter_info.PowerFactorB}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_PHASE_C_POWER_FACTOR:
                        AppendLog(ref dcu, true, false, $"Đọc Power factor C", Color.Black, Color.Black);
                        AppendLog(ref dcu, true, false, $"PF C: {clsRFSpider.meter_info.PowerFactorC}; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                        break;
                    case clsRFSpider.CMD_READ_TARIFF_INFO:
                        switch (dcu.cmds.sub_cmd)
                        {
                            case clsRFSpider.SUBCMD_READ_TARIFF_ALL:
                                if (clsRFSpider.index_tariff >= 0x00 && clsRFSpider.index_tariff <= 0x32)
                                {
                                    LogTariffInfo(ref dcu, clsRFSpider.index_tariff, clsRFSpider.meter_info.data, rssi, clsRFSpider.meter_info.warning.ToString(), clsRFSpider.meter_info.tamper.ToString(), diemDo.SPIDER_READ);
                                }
                                break;
                        }
                        break;
                    case clsRFSpider.CMD_RF_READ:
                        switch (dcu.cmds.sub_cmd)
                        {
                            case clsRFSpider.SUBCMD_RF_READ_EVENT:
                                if (clsRFSpider.index_event >= 0x00 && clsRFSpider.index_event <= 0x32)
                                {
                                    LogEventInfo(ref dcu, clsRFSpider.index_event, clsRFSpider.meter_info.data, rssi, clsRFSpider.meter_info.warning.ToString(), clsRFSpider.meter_info.tamper.ToString(), diemDo.SPIDER_READ);
                                }
                                break;
                        }
                        break;
                }
            }
            else
            {
                if (dcu.retry >= dcu.maxretry)
                {
                    switch (cmdType)
                    {
                        case clsRFSpider.CMD_READ_STAR:
                        case clsRFSpider.CMD_READ:
                        case clsRFSpider.CMD_READ_ALL:
                            AppendLog(ref dcu, true, false, $"Đọc kWh Import - kWh Export", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"kWhImport: FAIL; kWhExport: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thất bại: Đường dẫn: {diemDo.SPIDER_READ}", Color.Red, Color.Red);
                            break;
                        case clsRFSpider.CMD_READ_MESH:
                            switch (dcu.cmds.sub_cmd)
                            {
                                case clsRFSpider.SUBCMD_MESH_ENERGY:
                                    AppendLog(ref dcu, true, false, $"Đọc kWh Import - kWh Export", Color.Black, Color.Black);
                                    AppendLog(ref dcu, true, false, $"kWhImport: FAIL; kWhExport: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                                    AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thất bại: Đường dẫn: {diemDo.SPIDER_READ}", Color.Red, Color.Red);
                                    break;
                                case clsRFSpider.SUBCMD_MESH_TARIFF_REG_VALUE:
                                    if (clsRFSpider.index_tariff >= 0x00 && clsRFSpider.index_tariff <= 0x32)
                                    {
                                        LogTariffInfo(ref dcu, clsRFSpider.index_tariff, clsRFSpider.meter_info.data, rssi, clsRFSpider.meter_info.warning.ToString(), clsRFSpider.meter_info.tamper.ToString(), diemDo.SPIDER_READ);
                                    }
                                    break;
                            }
                            break;
                        case clsRFSpider.CMD_READ_KWH_EXPORT:
                            AppendLog(ref dcu, true, false, $"Đọc kWh Import - kWh Export", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"kWhImport: FAIL; kWhExport: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thất bại: Đường dẫn: {diemDo.SPIDER_READ}", Color.Red, Color.Red);
                            break;
                        case clsRFSpider.CMD_READ_VAR_IMPORT:
                            AppendLog(ref dcu, true, false, $"Đọc Var Import", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"varImport: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thất bại: Đường dẫn: {diemDo.SPIDER_READ}", Color.Red, Color.Red);
                            break;
                        case clsRFSpider.CMD_READ_VAR_EXPORT:
                            AppendLog(ref dcu, true, false, $"Đọc Var Export", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"varExport: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thất bại: Đường dẫn: {diemDo.SPIDER_READ}", Color.Red, Color.Red);
                            break;
                        //case clsRFSpider.SUBCMD_MESH_Q1_Q2:
                        case clsRFSpider.CMD_READ_Q1:
                        case clsRFSpider.CMD_READ_Q2:
                            AppendLog(ref dcu, true, false, $"Đọc Q1 - Q2", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Q1: FAIL; Q2: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thất bại: Đường dẫn: {diemDo.SPIDER_READ}", Color.Red, Color.Red);
                            break;
                        //case clsRFSpider.SUBCMD_MESH_Q3_Q4:
                        case clsRFSpider.CMD_READ_Q3:
                        case clsRFSpider.CMD_READ_Q4:
                            AppendLog(ref dcu, true, false, $"Đọc Q3 - Q4", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Q3: FAIL; Q4: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thất bại: Đường dẫn: {diemDo.SPIDER_READ}", Color.Red, Color.Red);
                            break;

                        //
                        case clsRFSpider.CMD_RF_READ_RTC:
                            AppendLog(ref dcu, true, false, $"Đọc RTC", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"RTC: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_VERSION:
                            AppendLog(ref dcu, true, false, $"Đọc Version", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Version: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_A_CURRENT:
                            AppendLog(ref dcu, true, false, $"Đọc dòng điện pha A", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Current A: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_B_CURRENT:
                            AppendLog(ref dcu, true, false, $"Đọc dòng điện pha B", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Current B: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_C_CURRENT:
                            AppendLog(ref dcu, true, false, $"Đọc dòng điện pha C", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Current C: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_A_VOLTAGE:
                            AppendLog(ref dcu, true, false, $"Đọc điện áp pha A", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Voltage A: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_B_VOLTAGE:
                            AppendLog(ref dcu, true, false, $"Đọc điện áp pha B", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Voltage B: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_C_VOLTAGE:
                            AppendLog(ref dcu, true, false, $"Đọc điện áp pha C", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"Voltage C: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_A_POWER_FACTOR:
                            AppendLog(ref dcu, true, false, $"Đọc Power factor A", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"PF A: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_B_POWER_FACTOR:
                            AppendLog(ref dcu, true, false, $"Đọc Power factor B", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"PF B: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                        case clsRFSpider.CMD_READ_PHASE_C_POWER_FACTOR:
                            AppendLog(ref dcu, true, false, $"Đọc Power factor C", Color.Black, Color.Black);
                            AppendLog(ref dcu, true, false, $"PF C: FAIL; Warning: {clsRFSpider.meter_info.warning}; Tamper: {clsRFSpider.meter_info.tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
                            break;
                    }
                }
                else
                {

                }

            }
        }
        private void LogTariffInfo(ref clientmanagerV4 dcu, byte index, string data, int rssi, string warning, string tamper, string path)
        {
            string tariffLabel = $"Biểu giá";
            AppendLog(ref dcu, true, false, $"Đọc {tariffLabel}", Color.Black, Color.Black);
            AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} giá trị {tariffLabel}: {data}; Đường dẫn: {path}; RSSI Meter: {rssi} dBm; Warning: {warning}; Tamper: {tamper}", Color.Blue, Color.Blue);
            AppendLog(ref dcu, true, false, $"{tariffLabel}: {data}; Warning: {warning}; Tamper: {tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
        }
        private void LogEventInfo(ref clientmanagerV4 dcu, byte index, string data, int rssi, string warning, string tamper, string path)
        {
            string eventLabel = $"Sự kiện";
            AppendLog(ref dcu, true, false, $"Đọc {eventLabel}", Color.Black, Color.Black);
            AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} giá trị {eventLabel}: {data}; Đường dẫn: {path}; RSSI Meter: {rssi} dBm; Warning: {warning}; Tamper: {tamper}", Color.Blue, Color.Blue);
            AppendLog(ref dcu, true, false, $"{eventLabel}: {data}; Warning: {warning}; Tamper: {tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
        }
        private void LogBIllingInfo(ref clientmanagerV4 dcu, int index, string data, int rssi, string warning, string tamper, string path)
        {
            string group = (index / 0x0100 == 0) ? "Group 00" : "Group 01"; // Phân nhóm 00xx và 01xx
            string subIndex = (index % 0x0100).ToString("D2"); // Lấy phần trăm, định dạng 2 chữ số (00-36)
            string billingLabel = $"{group} - Billing {subIndex}";
            if (group == "Group 01")
            {
                AppendLog(ref dcu, true, false, $"Đọc dữ liệu chốt, kỳ chốt thứ {subIndex}", Color.Black, Color.Black);
                AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} dữ liệu chốt, kỳ chốt thứ {subIndex}: {data}; Đường dẫn: {path}; RSSI Meter: {rssi} dBm; Warning: {warning}; Tamper: {tamper}", Color.Blue, Color.Blue);
                AppendLog(ref dcu, true, false, $"Dữ liệu chốt: {data}; Warning: {warning}; Tamper: {tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
            }
            else
            {
                AppendLog(ref dcu, true, false, $"Đọc thời gian chốt, kỳ chốt thứ {subIndex}", Color.Black, Color.Black);
                AppendLog(ref dcu, false, true, $"Đọc {dcu.cmds.serial} thời gian chốt, kỳ chốt thứ {subIndex}: {data}; Đường dẫn: {path}; RSSI Meter: {rssi} dBm; Warning: {warning}; Tamper: {tamper}", Color.Blue, Color.Blue);
                AppendLog(ref dcu, true, false, $"Thời gian chốt: {data}; Warning: {warning}; Tamper: {tamper}, RSSI Meter: {rssi} dBm", Color.Black, Color.Black);
            }
        }
        #endregion

        #region CHUYỂN TẦN SỐ
        private async Task SendRefreshCommands(clientmanagerV4 dcu, NetworkStream stream, DIEMDO diemDo)
        {
            if ((diemDo.VERSION_RF == "DT01PRF_433_1200_3BYTE_V100" || dcu.cmds.metertype == clsRFSpider.METER_TYPE.DDS26D) && dcu.previousIndex != dcu.currentindex)
            {
                clsData dataInstance = new clsData();
                List<byte[]> commandList1 = dataInstance.init_cmd_send_fre();

                foreach (var sendCmd in commandList1)
                {
                    await stream.WriteAsync(sendCmd, 0, sendCmd.Length);
                    AppendLog(ref dcu, true, false, $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t===>\t{BitConverter.ToString(sendCmd).Replace("-", "")}", Color.Red, Color.Red);

                    byte[] recvBuffer = new byte[256];
                    int amountRead = await stream.ReadAsync(recvBuffer, 0, recvBuffer.Length);
                    dcu.receivedData = recvBuffer.AsMemory(0, amountRead);

                    string str = Encoding.Latin1.GetString(dcu.receivedData.Span);
                    string hexString = BitConverter.ToString(dcu.receivedData.Span.ToArray()).Replace("-", "");

                    AppendLog(ref dcu, true, false, log: $"{dcu.mStation.IP_ADDRESS}:{dcu.mStation.PORT} \t<===\t{hexString}", color_rtbinfor: Color.Blue, color_rtblog: Color.Empty);

                    LogRawBytes(dcu.cmds.serial.ToString(), "SEND", sendCmd);
                    LogRawBytes(dcu.cmds.serial.ToString(), "RECV", dcu.receivedData.Span.ToArray());

                    await Task.Delay(500);
                }

                AppendLog(ref dcu, true, true, "Đã gửi thông điệp làm mới!", Color.DarkSeaGreen, Color.DarkSeaGreen);
            }
        }
        private async Task SendSetCC1101Frequency(NetworkStream stream, clientmanagerV4 dcu, byte frequency)
        {
            List<byte> cmd = new List<byte>();
            cmd.Add(0x68); // Start
            cmd.AddRange(BitConverter.GetBytes(dcu.masterID)); // ID thiết bị (toID)
            cmd.Add(0x68); // Start again
            cmd.Add(clsHU.CMD_SET_CONFIG_CC1101); // 0x85
            cmd.Add(frequency); // Tần số muốn đặt lại, ví dụ: 0x09 (433 MHz)
            cmd.Add(clsRFSpider.DLT645_STOP_BYTE); // 0x16

            byte[] send = cmd.ToArray();
            await stream.WriteAsync(send, 0, send.Length);

            string hex = BitConverter.ToString(send).Replace("-", "");
            clsLogFile.AppendRichTextBox(ref dcu.rtbinfo, $"Đã gửi lệnh set lại CC1101 về 433 MHz:\t{hex}", Color.Orange);

            // Đọc phản hồi (tùy chọn)
            byte[] recvBuffer = new byte[256];
            int amountRead = await stream.ReadAsync(recvBuffer, 0, recvBuffer.Length);
            if (amountRead > 0)
            {
                string hexResponse = BitConverter.ToString(recvBuffer, 0, amountRead).Replace("-", "");
                clsLogFile.AppendRichTextBox(ref dcu.rtbinfo, $"Phản hồi set CC1101:\t{hexResponse}", Color.Blue);
            }
        }
        #endregion
    }
}
